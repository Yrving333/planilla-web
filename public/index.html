<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planilla de Movilidad — S/45</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
/* ---- estilos (recortado para brevedad; UI limpio y funcional) ---- */
:root{--p:#2563eb;--p6:#1d4ed8;--ink:#0f172a;--mut:#64748b;--line:#e2e8f0;--bg:#f1f5f9;--card:#fff;--ok:#16a34a;--bad:#ef4444}
*{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);padding:20px;display:flex;justify-content:center}
.app{width:100%;max-width:1180px} .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.btn{border:1px solid var(--line);background:#fff;border-radius:12px;padding:9px 12px;font-weight:700;cursor:pointer}
.btn.primary{background:var(--p);color:#fff;border-color:var(--p)} .btn.primary:hover{background:var(--p6)}
.tabbar{display:flex;gap:12px;margin:6px 0 16px} .tab{border:none;background:transparent;padding:10px 14px;font-weight:700;border-bottom:2px solid transparent;color:var(--mut);cursor:pointer}
.tab.active{color:var(--p);border-bottom-color:var(--p)} .view{display:none}.view.active{display:block}
.card{background:var(--card);border-radius:16px;box-shadow:0 10px 28px rgba(2,8,23,.06);margin-bottom:14px;overflow:hidden}
.card-h,.card-b{padding:16px 18px}.card-h{border-bottom:1px solid var(--line)}
.brand{display:flex;justify-content:space-between;gap:12px}
#logo{max-height:40px;display:none} .cinfo{text-align:right;color:var(--mut);font-size:.9rem} .cinfo b{color:var(--ink)}
h1{margin:8px 0 2px;text-align:center;font-size:1.25rem} .sub{margin:0;text-align:center;color:var(--p);font-weight:800;font-size:.9rem}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px} .group label{font-weight:700;display:block;margin-bottom:6px}
.group input,.group select,.group textarea{width:100%;padding:9px 11px;border:1px solid var(--line);border-radius:10px}
.list{padding:0 18px 8px} .thead,.row{display:grid;grid-template-columns:34px 1.2fr 1.2fr 1fr .75fr .75fr;gap:8px;align-items:center}
.thead{padding:0 0 4px;color:var(--mut);text-transform:uppercase;font-size:.75rem}
.row{padding:6px 8px;border-bottom:1px solid var(--line);background:#fff}
.alert{margin:6px 18px 0;background:#fee2e2;color:#991b1b;padding:10px;border:1px solid #fecaca;border-radius:10px;display:none}
.total{padding:12px 18px;background:#f8fafc;border-top:1px solid var(--line);display:flex;gap:12px;justify-content:flex-end;flex-wrap:wrap}
.pill{font-size:.78rem;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:#fff}
.amount{font-weight:900} .ok{color:var(--ok)} .bad{color:var(--bad)}
.login{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:9999}
.login .box{background:#fff;border-radius:16px;padding:18px;min-width:320px;max-width:420px}
.table-wrap{overflow:auto} table{border-collapse:collapse;width:100%} th,td{border-bottom:1px solid var(--line);padding:6px 8px;font-size:.85rem;text-align:left}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div id="who" style="color:#64748b">No autenticado</div>
    <div>
      <button id="btnOpenLogin" class="btn">Iniciar sesión</button>
      <button id="btnLogout" class="btn" style="display:none">Cerrar sesión</button>
    </div>
  </div>

  <div class="tabbar">
    <button class="tab active" data-tab="new">Nueva Planilla</button>
    <button class="tab" data-tab="hist">Historial</button>
    <button class="tab" id="tabAdmin" data-tab="adm" style="display:none">Ajustes (Admin)</button>
  </div>

  <!-- NUEVA -->
  <div id="view-new" class="view active">
    <div class="card">
      <div class="card-h">
        <div class="brand">
          <img id="logo" alt="logo">
          <div class="cinfo"><b id="emp-razon">—</b><br>R.U.C. <span id="emp-ruc">—</span></div>
        </div>
        <h1>PLANILLA DE MOVILIDAD</h1>
        <p class="sub">PROYECTO PRINCIPAL: <span id="proydef">—</span></p>
      </div>
      <div class="card-b">
        <div class="grid">
          <div class="group">
            <label>Fecha de Emisión</label>
            <input id="f-emision" type="date">
          </div>
          <div class="group">
            <label>Trabajador Seleccionado</label>
            <select id="sel-trabajador"></select>
          </div>
        </div>
      </div>

      <div class="list">
        <div class="thead"><span>#</span><span>Destino</span><span>Motivo</span><span>Proyecto</span><span>PC</span><span>Monto (S/)</span></div>
        <div id="rows"></div>
      </div>

      <div id="over" class="alert"></div>

      <div class="total">
        <span class="pill">Tope por día: <b id="tTope">S/ 45.00</b></span>
        <span class="pill">Acumulado día: <b id="tAcum">S/ 0.00</b></span>
        <span class="pill">Disponible: <b id="tDisp">S/ 45.00</b></span>
        <span style="font-weight:800">Total:</span>
        <span id="tTotal" class="amount ok">S/ 0.00</span>
      </div>
    </div>

    <div style="display:flex;gap:8px">
      <button id="btnAdd" class="btn">+ Agregar fila</button>
      <button id="btnSave" class="btn primary">Finalizar, Guardar y Exportar a PDF</button>
    </div>
    <div style="height:8px"></div>
  </div>

  <!-- HISTORIAL -->
  <div id="view-hist" class="view">
    <div class="card">
      <div class="card-h" style="display:flex;justify-content:space-between;align-items:center">
        <b>Historial</b>
        <div>
          <button id="btnHistMine" class="btn">Mi historial</button>
          <button id="btnHistAll" class="btn" title="Requiere PIN admin">Todos (admin)</button>
        </div>
      </div>
      <div class="card-b">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Fecha</th><th>Serie</th><th>#</th><th>Total</th><th>Items</th></tr></thead>
            <tbody id="hist"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="view-adm" class="view">
    <div class="card">
      <div class="card-h"><b>Validar PIN admin</b></div>
      <div class="card-b" style="display:flex;gap:8px;align-items:center">
        <input id="pin" type="password" placeholder="PIN (ADMIN_PIN)"><button id="btnPin" class="btn primary">Ingresar</button>
        <span id="pinOk" style="color:#059669;font-weight:700"></span>
      </div>
    </div>

    <div class="card">
      <div class="card-h"><b>Empresas</b>
        <div style="float:right;display:flex;gap:8px">
          <button id="empSave" class="btn primary" disabled>Guardar</button>
        </div>
      </div>
      <div class="card-b"><div class="table-wrap"><table>
        <thead><tr><th>ID</th><th>Razon</th><th>RUC</th><th>Direccion</th><th>Telefono</th></tr></thead>
        <tbody id="empTable"></tbody>
      </table></div></div>
    </div>

    <div class="card">
      <div class="card-h"><b>Usuarios</b>
        <div style="float:right;display:flex;gap:8px">
          <button id="usrSave" class="btn primary" disabled>Guardar</button>
        </div>
      </div>
      <div class="card-b"><div class="table-wrap"><table>
        <thead><tr><th>Email</th><th>DNI</th><th>Nombres</th><th>Apellidos</th><th>Rol</th><th>Activo</th><th>Empresa</th><th>ProyDef</th><th>Proys (coma)</th></tr></thead>
        <tbody id="usrTable"></tbody>
      </table></div></div>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="login" class="login">
    <div class="box">
      <h3>Iniciar sesión</h3>
      <div class="group"><label>Email</label><input id="loginEmail" type="email" placeholder="admin@empresa.com"></div>
      <div class="group"><label>Clave</label><input id="loginPass" type="password" placeholder="******"></div>
      <div style="font-size:.85rem;color:#64748b;margin-top:6px">Se valida contra la tabla <b>usuarios</b>. La clave no se evalúa.</div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="btnLogin" class="btn primary">Entrar</button></div>
    </div>
  </div>
</div>

<script>
/* ===== Estado global ===== */
const state = {
  empresas: [],
  usuarios: [],
  user: null,
  tope: 45,
  pin: ''
};

/* ===== Utils ===== */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const money = n => 'S/ ' + Number(n||0).toFixed(2);
const toNum = v => {
  if (v==null) return 0;
  let s = String(v).trim().replace(/,/g,'.').replace(/[^0-9.\-]/g,'');
  const p=s.split('.'); if(p.length>2){const l=p.pop(); s=p.join('')+'.'+l;}
  const n = parseFloat(s); return Number.isFinite(n)?Number(n.toFixed(2)):0;
};
async function api(path, opt={}){
  const r = await fetch(path, { headers:{'Content-Type':'application/json'}, credentials:'same-origin', ...opt });
  let d=null; try{ d=await r.json(); }catch{}
  if(!r.ok) throw new Error((d&&d.msg)||('HTTP '+r.status));
  return d;
}

/* ===== Login ===== */
function openLogin(){ qs('#login').style.display='flex'; }
function closeLogin(){ qs('#login').style.display='none'; }

async function doLogin(email){
  const u = await api('/api/login?email='+encodeURIComponent(email));
  if (!u.activo) throw new Error('Usuario inactivo');
  state.user = u;
  localStorage.setItem('planilla_email', u.email);
  renderHeader();
  fillTrabajadores();
  renderRows(true);
  qs('#btnOpenLogin').style.display='none';
  qs('#btnLogout').style.display='';
  closeLogin();
}

/* ===== Datos base ===== */
async function loadBase(){
  try {
    const ping = await api('/api/ping');
    state.tope = Number(ping.tope || 45);
    qs('#tTope').textContent = money(state.tope);
    qs('#tDisp').textContent = money(state.tope);
  } catch {}

  state.empresas = await api('/api/empresas');
  state.usuarios = await api('/api/usuarios');

  let email = localStorage.getItem('planilla_email') || '';
  if (email) {
    try { await doLogin(email); return; } catch {}
  }
  openLogin();
}

/* ===== UI cabecera & trabajador ===== */
function renderHeader(){
  const u = state.user;
  const who = u ? `Conectado: ${u.nombres} ${u.apellidos} — ${u.email} — Rol: ${u.rol}` : 'No autenticado';
  qs('#who').textContent = who;

  const emp = state.empresas.find(e => e.id === (u?.empresaid || ''));
  qs('#emp-razon').textContent = emp?.razon || '—';
  qs('#emp-ruc').textContent = emp?.ruc || '—';
  qs('#proydef').textContent = (u?.proydef || '—').toUpperCase();
  if (emp?.logo) {
    const img = qs('#logo'); img.src = emp.logo; img.style.display='inline-block';
  }

  // admin tab visible sólo si rol = ADMIN_PADOVA
  qs('#tabAdmin').style.display = (u?.rol === 'ADMIN_PADOVA') ? '' : 'none';
}
function fillTrabajadores(){
  const sel = qs('#sel-trabajador'); sel.innerHTML='';
  state.usuarios.filter(u => u.activo).forEach(u=>{
    const o = document.createElement('option');
    o.value = u.email; o.textContent = `${u.nombres} ${u.apellidos}`;
    if (state.user && u.email.toLowerCase() === state.user.email.toLowerCase()) o.selected = true;
    sel.appendChild(o);
  });
  sel.onchange = async () => {
    const em = sel.value;
    const u = state.usuarios.find(x => x.email.toLowerCase() === em.toLowerCase());
    if (u){ state.user = u; localStorage.setItem('planilla_email', u.email); renderHeader(); recalc(); }
  };
}

/* ===== Filas ===== */
function rowTpl(i){
  return `
    <div class="row">
      <div style="text-align:center;font-weight:700">${i+1}</div>
      <input class="destino" placeholder="DESTINO">
      <input class="motivo" placeholder="MOTIVO">
      <input class="proyecto" placeholder="PROYECTO" value="${(state.user?.proydef||'').toUpperCase()}">
      <input class="pc" placeholder="94303">
      <input class="monto" placeholder="0.00">
    </div>
  `;
}
function renderRows(first=false){
  const cont = qs('#rows');
  if (first || !cont.children.length){
    cont.innerHTML = '';
    for (let i=0;i<5;i++) cont.insertAdjacentHTML('beforeend', rowTpl(i));
  }
  qsa('#rows .monto, #rows .destino, #rows .motivo, #rows .proyecto, #rows .pc')
    .forEach(el => el.addEventListener('input', recalc));
}
function addRow(){
  const cont = qs('#rows');
  cont.insertAdjacentHTML('beforeend', rowTpl(cont.children.length));
  renderRows();
}

/* ===== Totales / tope ===== */
async function recalc(){
  const items = getItems();
  const total = Number(items.reduce((a,x)=>a+Number(x.monto||0),0).toFixed(2));
  qs('#tTotal').textContent = money(total);
  qs('#tTotal').className = 'amount ' + (total>state.tope ? 'bad' : 'ok');

  const fecha = qs('#f-emision').value || new Date().toISOString().slice(0,10);
  if (state.user?.dni && fecha){
    try {
      const r = await api(`/api/acumulado?dni=${encodeURIComponent(state.user.dni)}&fecha=${encodeURIComponent(fecha)}`);
      qs('#tAcum').textContent = money(r.acc);
      const disp = Math.max(0, Number(state.tope) - Number(r.acc));
      qs('#tDisp').textContent = money(disp);
      const over = qs('#over');
      if (total > disp){
        over.style.display='block';
        over.textContent = `Has superado el tope disponible de ${money(disp)} para la fecha seleccionada.`;
      } else {
        over.style.display='none'; over.textContent='';
      }
    } catch {}
  }
}
function getItems(){
  const rows = qsa('#rows .row');
  const out = [];
  rows.forEach(r=>{
    const destino  = (r.querySelector('.destino')?.value||'').trim().toUpperCase();
    const motivo   = (r.querySelector('.motivo')?.value||'').trim().toUpperCase();
    const proyecto = (r.querySelector('.proyecto')?.value||'').trim().toUpperCase();
    const pc       = (r.querySelector('.pc')?.value||'').trim();
    const monto    = toNum(r.querySelector('.monto')?.value);
    if (monto>0) out.push({ destino, motivo, proyecto, pc, monto });
  });
  return out;
}

/* ===== Guardar + PDF ===== */
async function savePlanilla(){
  if (!state.user) { openLogin(); return; }
  const fecha = qs('#f-emision').value || new Date().toISOString().slice(0,10);
  const items = getItems();
  if (!items.length) { alert('Ingrese al menos un ítem con monto.'); return; }
  qs('#btnSave').disabled = true;
  try{
    const r = await api('/api/planillas', {
      method:'POST',
      body: JSON.stringify({
        dni: state.user.dni,
        email: state.user.email,
        fecha, items
      })
    });
    await exportPDF({
      fecha, items,
      total: r.total, serie: r.serie, num: r.num,
      emp: r.empresa, u: state.user
    });
    alert(`Planilla ${r.serie}-${String(r.num).padStart(5,'0')} guardada y exportada.`);
    loadHistMine(); // refresca historial
  }catch(e){
    alert(e.message||'Error al guardar');
  }finally{ qs('#btnSave').disabled = false; }
}
async function exportPDF({ fecha, items, total, serie, num, emp, u }){
  const jsPDFCtor=(window.jspdf&&window.jspdf.jsPDF)||window.jsPDF; if(!jsPDFCtor) throw new Error('jsPDF no disponible');
  const doc=new jsPDFCtor({unit:'pt',format:'a4'});
  const razon=emp?.razon||'PADOVA', ruc=emp?.ruc||'—';
  doc.setFontSize(12); doc.text(razon,40,40); doc.text('R.U.C.: '+ruc,40,58);
  doc.setFontSize(14); doc.text('PLANILLA DE MOVILIDAD',300,40,{align:'center'}); doc.text(`Planilla Nro. ${serie}-${String(num).padStart(5,'0')}`,300,58,{align:'center'});
  doc.setFontSize(10); const trabajador=`${(u?.nombres||'').toUpperCase()} ${(u?.apellidos||'').toUpperCase()}  DNI: ${u?.dni||''}`;
  doc.text('Fecha de Emisión: '+fecha,40,90); doc.text('Trabajador: '+trabajador,40,108);
  let y=140; const cols=['#','DESTINO','MOTIVO','PROYECTO','PC','MONTO (S/)'], w=[24,120,120,140,60,80];
  const row=(c,yy,h)=>{let x=40; for(let i=0;i<c.length;i++){doc.rect(x,yy,w[i],22); doc.setFontSize(h?10:9); doc.text(String(c[i]??''),x+3,yy+14); x+=w[i];}};
  row(cols,y,true); y+=22;
  items.forEach((it,i)=>{ if(y>760){doc.addPage(); y=40;} row([i+1,it.destino,it.motivo,it.proyecto,it.pc,Number(it.monto).toFixed(2)],y); y+=22; });
  y+=10; doc.setFontSize(12); doc.text('Total: '+money(total),40,y+20);
  doc.save(`${serie}-${String(num).padStart(5,'0')}.pdf`);
}

/* ===== Historial ===== */
function renderHist(rows){
  const tb = qs('#hist'); tb.innerHTML='';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.fecha}</td><td>${r.serie}</td><td>${String(r.num).padStart(5,'0')}</td><td>${money(r.total)}</td><td>${(r.items||[]).length}</td>`;
    tb.appendChild(tr);
  });
}
async function loadHistMine(){
  if (!state.user) return;
  const rows = await api('/api/historial?email='+encodeURIComponent(state.user.email));
  renderHist(rows);
}
async function loadHistAll(){
  const pin = state.pin || prompt('PIN admin:') || '';
  state.pin = pin;
  const r = await fetch('/api/historial?all=1',{ headers:{'x-admin-pin':pin} });
  if(!r.ok){ alert('PIN inválido'); return; }
  renderHist(await r.json());
}

/* ===== Admin ===== */
let empModel=[], usrModel=[];
function fillEmpTable(){
  const tb=qs('#empTable'); tb.innerHTML='';
  empModel.forEach((e,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td contenteditable>${e.id}</td>
      <td contenteditable>${e.razon||''}</td>
      <td contenteditable>${e.ruc||''}</td>
      <td contenteditable>${e.direccion||''}</td>
      <td contenteditable>${e.telefono||''}</td>`;
    tb.appendChild(tr);
  });
}
function fillUsrTable(){
  const tb=qs('#usrTable'); tb.innerHTML='';
  usrModel.forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td contenteditable>${u.email}</td>
      <td contenteditable>${u.dni}</td>
      <td contenteditable>${u.nombres}</td>
      <td contenteditable>${u.apellidos}</td>
      <td contenteditable>${u.rol}</td>
      <td contenteditable>${u.activo}</td>
      <td contenteditable>${u.empresaid||''}</td>
      <td contenteditable>${u.proydef||''}</td>
      <td contenteditable>${(u.proys||[]).join(', ')}</td>
    `;
    tb.appendChild(tr);
  });
}
async function adminEnter(){
  const pin = qs('#pin').value.trim();
  if (!pin) { alert('Ingresa PIN'); return; }
  // Hacemos una llamada que requiera PIN para validar
  const r = await fetch('/api/historial?all=1',{ headers:{'x-admin-pin':pin} });
  if(!r.ok){ alert('PIN inválido'); return; }
  state.pin = pin; qs('#pinOk').textContent = 'OK';
  empModel = await api('/api/empresas'); fillEmpTable(); qs('#empSave').disabled=false;
  usrModel = await api('/api/usuarios'); fillUsrTable(); qs('#usrSave').disabled=false;
}
async function adminSaveEmp(){
  // Leer tabla editable
  const rows = qsa('#empTable tr').map(tr=>{
    const tds = tr.querySelectorAll('td');
    return { id:tds[0].innerText.trim(), razon:tds[1].innerText.trim(), ruc:tds[2].innerText.trim(),
             direccion:tds[3].innerText.trim(), telefono:tds[4].innerText.trim() };
  });
  const r = await fetch('/api/empresas',{ method:'PUT', headers:{'Content-Type':'application/json','x-admin-pin':state.pin}, body:JSON.stringify(rows) });
  if(!r.ok){ alert('Error guardando empresas'); return; }
  empModel = await r.json(); fillEmpTable(); alert('Empresas guardadas');
}
async function adminSaveUsr(){
  const rows = qsa('#usrTable tr').map(tr=>{
    const t=tr.querySelectorAll('td');
    return {
      email:t[0].innerText.trim(), dni:t[1].innerText.trim(), nombres:t[2].innerText.trim(), apellidos:t[3].innerText.trim(),
      rol:t[4].innerText.trim(), activo: (String(t[5].innerText).trim().toLowerCase()!=='false'),
      empresaid:t[6].innerText.trim(), proydef:t[7].innerText.trim(),
      proys: t[8].innerText.split(',').map(s=>s.trim()).filter(Boolean)
    };
  });
  const r = await fetch('/api/usuarios',{ method:'PUT', headers:{'Content-Type':'application/json','x-admin-pin':state.pin}, body:JSON.stringify(rows) });
  if(!r.ok){ alert('Error guardando usuarios'); return; }
  usrModel = await r.json(); fillUsrTable(); alert('Usuarios guardados');
}

/* ===== Tabs & eventos ===== */
qsa('.tab').forEach(b=>{
  b.onclick = ()=>{
    qsa('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    qsa('.view').forEach(v=>v.classList.remove('active'));
    qs('#view-'+b.dataset.tab).classList.add('active');
    if (b.dataset.tab==='hist') loadHistMine();
  };
});

qs('#btnOpenLogin').onclick = openLogin;
qs('#btnLogin').onclick = async ()=>{
  const e = qs('#loginEmail').value.trim() || 'admin@empresa.com';
  try{ await doLogin(e); }catch(err){ alert(err.message||'No se pudo iniciar sesión'); }
};
qs('#btnLogout').onclick = ()=>{ state.user=null; localStorage.removeItem('planilla_email'); openLogin(); renderHeader(); };
qs('#btnAdd').onclick = addRow;
qs('#btnSave').onclick = savePlanilla;
qs('#btnHistMine').onclick = loadHistMine;
qs('#btnHistAll').onclick = loadHistAll;
qs('#btnPin').onclick = adminEnter;
qs('#empSave').onclick = adminSaveEmp;
qs('#usrSave').onclick = adminSaveUsr;

document.addEventListener('DOMContentLoaded', async ()=>{
  await loadBase();
  renderRows(true);
  recalc();
});
</script>
<script>
/* ==== HOTFIX UI: filas + totales + guardar + PDF + header empresa ==== */
(function () {
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const money = v => 'S/ ' + Number(v || 0).toFixed(2);
  const toNum = v => {
    if (v == null) return 0;
    let s = String(v).trim().replace(/,/g, '.').replace(/[^0-9.\-]/g, '');
    const p = s.split('.'); if (p.length > 2) { const l = p.pop(); s = p.join('') + '.' + l; }
    const n = parseFloat(s);
    return Number.isFinite(n) ? Number(n.toFixed(2)) : 0;
  };
  async function api(path, opt = {}) {
    const r = await fetch(path, { headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', ...opt });
    let d = null; try { d = await r.json(); } catch {}
    if (!r.ok) throw new Error((d && (d.msg || d.error)) || ('HTTP ' + r.status));
    return d;
  }

  const ui = {
    rows: $('#rows'),
    fecha: $('#f-emision'),
    trabajador: $('#sel-trabajador'),
    btnSave: $('#btn-save') || $('#btnSave') || $('#btn-guardar') || $('#btn-exportar'),
    totalTxt: $('#total') || $('#tTotal'),
    acumTxt: $('#pill-acum') || $('#tAcum'),
    dispTxt: $('#pill-disp') || $('#tDisp'),
    topeTxt: $('#tTope'),
    alert: $('#over-alert') || $('#over')
  };

  const state = { empresas: [], usuarios: [], user: null, tope: 45 };

  function rowHTML(i) {
    return `
      <div class="trow row">
        <div class="num" style="text-align:center;font-weight:700">${i + 1}</div>
        <input class="destino" placeholder="DESTINO">
        <input class="motivo" placeholder="MOTIVO">
        <input class="proyecto" placeholder="PROYECTO">
        <input class="pc" placeholder="94303">
        <input class="monto" placeholder="0.00">
      </div>`;
  }
  function renderRows(initial = false) {
    if (!ui.rows) return;
    if (initial || !ui.rows.children.length) {
      ui.rows.innerHTML = '';
      for (let i = 0; i < 5; i++) ui.rows.insertAdjacentHTML('beforeend', rowHTML(i));
    }
    $$('.trow .monto, .trow .destino, .trow .motivo, .trow .proyecto, .trow .pc')
      .forEach(el => el.addEventListener('input', recalc));
    // Proyecto por defecto del usuario
    $$('.trow .proyecto').forEach(el => {
      if (state.user?.proydef && !el.value) el.value = String(state.user.proydef || '').toUpperCase();
    });
  }
  function getItems() {
    return $$('.trow').map(r => {
      const g = sel => (r.querySelector(sel)?.value || '').trim();
      const destino = g('.destino').toUpperCase();
      const motivo  = g('.motivo').toUpperCase();
      const proyecto= g('.proyecto').toUpperCase();
      const pc      = g('.pc');
      const monto   = toNum(r.querySelector('.monto')?.value);
      return (monto > 0) ? { destino, motivo, proyecto, pc, monto } : null;
    }).filter(Boolean);
  }
  async function recalc() {
    try {
      const items = getItems();
      const total = Number(items.reduce((a, x) => a + Number(x.monto || 0), 0).toFixed(2));
      if (ui.totalTxt) {
        ui.totalTxt.textContent = money(total);
        ui.totalTxt.className = (ui.totalTxt.className || '').replace(/\b(ok|bad)\b/g, '') + ' ' + (total > state.tope ? 'bad' : 'ok');
      }
      const fecha = ui.fecha?.value || new Date().toISOString().slice(0, 10);
      if (state.user?.dni && fecha) {
        const r = await api(`/api/acumulado?dni=${encodeURIComponent(state.user.dni)}&fecha=${encodeURIComponent(fecha)}`);
        if (ui.acumTxt) ui.acumTxt.textContent = money(r.acc);
        const disp = Math.max(0, Number(state.tope) - Number(r.acc));
        if (ui.dispTxt) ui.dispTxt.textContent = money(disp);
        if (ui.alert) {
          if (total > disp) {
            ui.alert.style.display = 'block';
            ui.alert.textContent = `Has superado el tope disponible de ${money(disp)}.`;
          } else {
            ui.alert.style.display = 'none';
            ui.alert.textContent = '';
          }
        }
      }
    } catch (e) { /* silencioso */ }
  }

  async function save() {
    const items = getItems();
    if (!state.user) { alert('Inicia sesión primero.'); return; }
    if (!items.length) { alert('Ingrese al menos un ítem con monto.'); return; }
    const fecha = ui.fecha?.value || new Date().toISOString().slice(0, 10);
    if (ui.btnSave) ui.btnSave.disabled = true;
    try {
      const r = await api('/api/planillas', {
        method: 'POST',
        body: JSON.stringify({ dni: state.user.dni, email: state.user.email, fecha, items })
      });
      await exportPDF({ fecha, items, total: r.total, serie: r.serie, num: r.num, emp: r.empresa, u: state.user });
      alert(`Planilla ${r.serie}-${String(r.num).padStart(5, '0')} guardada y exportada.`);
    } catch (e) {
      alert(e.message || 'Error al guardar');
    } finally { if (ui.btnSave) ui.btnSave.disabled = false; }
  }

  async function exportPDF({ fecha, items, total, serie, num, emp, u }) {
    const ctor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
    if (!ctor) { alert('No se pudo cargar jsPDF'); return; }
    const doc = new ctor({ unit: 'pt', format: 'a4' });
    const razon = emp?.razon || 'PADOVA', ruc = emp?.ruc || '—';
    doc.setFontSize(12); doc.text(razon, 40, 40); doc.text('R.U.C.: ' + ruc, 40, 58);
    doc.setFontSize(14); doc.text('PLANILLA DE MOVILIDAD', 300, 40, { align: 'center' });
    doc.text(`Planilla Nro. ${serie}-${String(num).padStart(5, '0')}`, 300, 58, { align: 'center' });
    doc.setFontSize(10);
    const trb = `${(u?.nombres || '').toUpperCase()} ${(u?.apellidos || '').toUpperCase()}  DNI: ${u?.dni || ''}`;
    doc.text('Fecha de Emisión: ' + fecha, 40, 90);
    doc.text('Trabajador: ' + trb, 40, 108);
    let y = 140;
    const cols = ['#', 'DESTINO', 'MOTIVO', 'PROYECTO', 'PC', 'MONTO (S/)'], w = [24, 120, 120, 140, 60, 80];
    const row = (c, yy, h) => { let x = 40; for (let i = 0; i < c.length; i++) { doc.rect(x, yy, w[i], 22); doc.setFontSize(h ? 10 : 9); doc.text(String(c[i] ?? ''), x + 3, yy + 14); x += w[i]; } };
    row(cols, y, true); y += 22;
    items.forEach((it, i) => { if (y > 760) { doc.addPage(); y = 40; } row([i + 1, it.destino, it.motivo, it.proyecto, it.pc, Number(it.monto).toFixed(2)], y); y += 22; });
    y += 10; doc.setFontSize(12); doc.text('Total: ' + money(total), 40, y + 20);
    doc.save(`${serie}-${String(num).padStart(5, '0')}.pdf`);
  }

  async function loadBase() {
    try { const p = await api('/api/ping'); state.tope = Number(p.tope || 45); } catch {}
    if (ui.topeTxt) ui.topeTxt.textContent = money(state.tope);
    try { state.empresas = await api('/api/empresas'); } catch {}
    try { state.usuarios = await api('/api/usuarios'); } catch {}

    // Usuario desde localStorage o admin por defecto
    let email = ''; try { email = localStorage.getItem('planilla_email') || ''; } catch {}
    if (!email) email = 'admin@empresa.com';
    try {
      const u = await api('/api/login?email=' + encodeURIComponent(email));
      state.user = u;
      // Cabecera empresa
      const emp = state.empresas.find(e => e.id === (u?.empresaid || ''));
      const razonEls = $$('#emp-razon, #razon, .emp-razon'); const rucEls = $$('#emp-ruc, #ruc, .emp-ruc');
      razonEls.forEach(el => el.textContent = emp?.razon || '—');
      rucEls.forEach(el => el.textContent = emp?.ruc || '—');
      const proyDefEl = $('#proydef'); if (proyDefEl) proyDefEl.textContent = (u?.proydef || '—').toUpperCase();
      // Trabajadores
      if (ui.trabajador) {
        ui.trabajador.innerHTML = '';
        state.usuarios.filter(x => x.activo).forEach(x => {
          const o = document.createElement('option');
          o.value = x.email; o.textContent = `${x.nombres} ${x.apellidos}`;
          if (x.email.toLowerCase() === u.email.toLowerCase()) o.selected = true;
          ui.trabajador.appendChild(o);
        });
        ui.trabajador.onchange = async () => {
          const em = ui.trabajador.value;
          const nx = state.usuarios.find(x => x.email.toLowerCase() === em.toLowerCase());
          if (nx) { state.user = nx; recalc(); }
        };
      }
    } catch {}
  }

  // Arranque
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await loadBase();
      renderRows(true);
      recalc();
      if (ui.btnSave) ui.btnSave.addEventListener('click', save);
      // Recalcular cuando cambia la fecha
      if (ui.fecha) ui.fecha.addEventListener('change', recalc);
    } catch (e) {
      console.error('HOTFIX:', e);
      alert('No se pudo inicializar la UI (hotfix).');
    }
  });
})();
</script>
</body>
</html>
