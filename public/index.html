<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planilla de Movilidad ‚Äî S/45</title>

<!-- jsPDF para exportar PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  :root{
    --primary:#2563eb;--primary-600:#1d4ed8;
    --ink:#0f172a;--muted:#64748b;--line:#e2e8f0;
    --bg:#f1f5f9;--card:#ffffff;--chip:#f8fafc;
    --ok:#16a34a;--bad:#ef4444;--zebra:#fafafa
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);padding:20px;display:flex;justify-content:center}
  .app{width:100%;max-width:1180px}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .who{font-size:.88rem;color:var(--muted)}
  .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;letter-spacing:.2px}
  .btn.primary{background:var(--primary);color:#fff;box-shadow:0 6px 20px rgba(37,99,235,.18)}
  .btn.primary:hover{background:var(--primary-600)}
  .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
  .btn.small{padding:7px 10px;font-size:.9rem}
  .tabs{display:flex;gap:12px;margin-bottom:16px}
  .tab{padding:10px 16px;border:none;background:transparent;border-bottom:2px solid transparent;color:var(--muted);cursor:pointer;font-weight:700}
  .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
  .view{display:none}.view.active{display:block}

  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 28px rgba(2,8,23,.06);margin-bottom:16px;overflow:hidden}
  .card-h,.card-b{padding:18px 20px}.card-h{border-bottom:1px solid var(--line);background:linear-gradient(180deg,#ffffff,#fbfdff)}
  .brand{display:flex;justify-content:space-between;gap:16px;align-items:flex-start}
  .brand img{max-height:42px}
  .cinfo{font-size:.86rem;color:var(--muted);text-align:right;line-height:1.45}
  .cinfo b{color:var(--ink)}
  h1.title{margin:8px 0 2px;text-align:center;font-size:1.28rem;letter-spacing:.2px}
  .subtitle{margin:0;text-align:center;color:#1d4ed8;font-weight:800;font-size:.92rem}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .group label{display:block;margin:0 0 6px;font-weight:700;font-size:.9rem}
  .group input,.group select,.group textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:.95rem;background:#fff}
  .uppercase{text-transform:uppercase}
  .worker-row{display:flex;gap:8px;align-items:flex-end}

  .list{padding:0 20px 10px}
  .thead,.trow{display:grid;grid-template-columns:34px 1.2fr 1.2fr 1fr .7fr .7fr 38px;gap:10px;align-items:center}
  .thead{padding:0 0 6px;color:var(--muted);text-transform:uppercase;font-size:.72rem}
  .trow{padding:6px 10px;border-bottom:1px solid var(--line);background:#fff}
  .trow:nth-child(odd){background:var(--zebra)}
  .trow input,.trow select{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .num{color:var(--muted);text-align:center;font-weight:900}

  .alert{width:calc(100% - 40px);background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:12px;padding:10px 12px;margin:6px 20px 0;display:none}
  .total{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;align-items:center;background:var(--chip);border-top:1px solid var(--line);padding:14px 20px}
  .pill{font-size:.78rem;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:white}
  .amount{font-size:1.22rem;font-weight:900}
  .amount.ok{color:var(--ok)} .amount.bad{color:var(--bad)}
  .legal{font-size:.75rem;color:#6b7280;text-align:justify;padding:0 20px 18px}

  .table-wrap{overflow-x:auto}
  table.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
  .tbl th,.tbl td{border-bottom:1px solid var(--line);padding:5px 6px;text-align:left;font-size:.76rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tbl th{background:#f8fafc;text-transform:uppercase;font-size:.7rem}
  .center{text-align:center}
  .w-s{width:78px;min-width:78px}
  .w-m{width:108px;min-width:108px}
  .w-l{width:160px;min-width:160px}

  .login-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
  .login-card{background:#fff;border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.25);padding:22px 20px;min-width:340px;max-width:420px}
  .login-card h3{margin:0 0 6px}
  .hint{font-size:.82rem;color:var(--muted);margin-top:4px}
  .login-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end;flex-wrap:wrap}
  .danger{background:#ef4444;color:#fff}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="who" id="who">No autenticado</div>
    <div>
      <button id="btn-login" class="btn primary">Iniciar sesi√≥n</button>
      <button id="btn-logout" class="btn ghost" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="new">Nueva Planilla</button>
    <button class="tab" data-tab="hist">Historial</button>
    <button id="tab-admin" class="tab" data-tab="admin" style="display:none">Ajustes (Admin)</button>
  </div>

  <!-- NUEVA -->
  <div id="view-new" class="view active">
    <div class="card">
      <div class="card-h">
        <div class="brand">
          <img id="logo" alt="Logo empresa" style="display:none">
          <div id="cinfo" class="cinfo"><b id="emp-razon">‚Äî</b><br>R.U.C. <span id="emp-ruc">‚Äî</span><br><span id="caddr"></span></div>
        </div>
        <h1 id="h-num" class="title">PLANILLA DE MOVILIDAD</h1>
        <p id="p-proy" class="subtitle">PROYECTO PRINCIPAL: ‚Äî</p>
      </div>
      <div class="card-b">
        <div class="grid">
          <div class="group">
            <label for="f-emision">Fecha de Emisi√≥n</label>
            <input id="f-emision" type="date">
          </div>
          <div class="worker-row">
            <div class="group" style="flex:1">
              <label for="sel-trabajador">Trabajador Seleccionado</label>
              <select id="sel-trabajador"></select>
            </div>
            <button id="btn-new-worker" class="btn ghost small" title="(Admin) Nuevo trabajador" disabled>+</button>
            <button id="btn-edit-worker" class="btn ghost small" title="(Admin) Editar trabajador" disabled>‚úé</button>
          </div>
        </div>
      </div>

      <div class="list">
        <div class="thead">
          <span>#</span><span>Destino</span><span>Motivo</span><span>Proyecto</span><span>PC</span><span>Monto (S/)</span><span></span>
        </div>
        <div id="rows"></div>
      </div>

      <div id="over-alert" class="alert">Has superado el tope de <b id="topeLabel">S/ 45.00</b> por d√≠a/usuario. Ajusta los montos o cambia la fecha.</div>

      <div class="total">
        <span class="pill">Tope por d√≠a: <b id="pill-tope">S/ 45.00</b></span>
        <span class="pill">Acumulado d√≠a: <b id="pill-acum">S/ 0.00</b></span>
        <span class="pill">Disponible: <b id="pill-disp">S/ 45.00</b></span>
        <span style="font-weight:800">Total:</span>
        <span id="total" class="amount ok">S/ 0.00</span>
      </div>

      <div class="legal">
        <b>Base Legal:</b> Inciso a1) del art√≠culo 37¬∞ del TUO de la Ley del Impuesto a la Renta e inciso v) del art√≠culo 21¬∞ del Reglamento de la ley del Impuesto a la Renta. Nota: La falta de consignaci√≥n de la fecha en que se incurri√≥ en el gasto, nombres y apellidos de cada trabajador, n√∫mero de DNI, motivo y destino del desplazamiento y monto gastado, respecto a cada desplazamiento s√≥lo inhabilita la planilla para la sustentaci√≥n del gasto que corresponda a tal desplazamiento. (*) Numeraci√≥n de la planilla.
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center">
      <button id="btn-add-row" class="btn ghost">+ Agregar fila</button>
      <button id="btn-save" class="btn primary">Finalizar, Guardar y Exportar a PDF</button>
    </div>
  </div>

  <!-- HISTORIAL -->
  <div id="view-hist" class="view">
    <div class="card">
      <div class="card-h" style="display:flex;justify-content:space-between;align-items:center">
        <b>Historial de Planillas</b>
        <div id="hist-admin-actions" style="display:none;gap:8px">
          <label class="pill"><input type="checkbox" id="hist-all"> Ver todos (admin)</label>
        </div>
      </div>
      <div class="card-b"><div class="table-wrap"><div id="hist"></div></div></div>
    </div>
  </div>

  <!-- AJUSTES (ADMIN) -->
  <div id="view-admin" class="view">
    <div class="card">
      <div class="card-h"><b>Acceso administrador</b></div>
      <div class="card-b" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="pin-in" type="password" placeholder="PIN admin" style="max-width:220px">
        <button class="btn primary" id="btn-admin-pin">Ingresar</button>
        <span id="pin-ok" style="color:#059669;font-weight:700"></span>
      </div>
    </div>

    <div class="card">
      <div class="card-h"><b>Empresas</b></div>
      <div class="card-b">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="emp-add" class="btn ghost" disabled>Agregar empresa</button>
          <button id="emp-save" class="btn primary" disabled>Guardar cambios</button>
        </div>
        <div class="table-wrap"><div id="emp-table"></div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-h"><b>Usuarios</b></div>
      <div class="card-b">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="usr-add" class="btn ghost" disabled>Agregar usuario</button>
          <button id="usr-save" class="btn primary" disabled>Guardar cambios</button>
        </div>
        <div class="table-wrap"><div id="usr-table"></div></div>
      </div>
    </div>
  </div>

  <!-- LOGIN OVERLAY -->
  <div id="login-overlay" class="login-overlay" style="display:flex">
    <div class="login-card">
      <h3>Iniciar sesi√≥n</h3>
      <div class="group"><label>Email</label><input id="login-email" type="email" placeholder="admin@empresa.com"></div>
      <div class="hint">Se valida contra la tabla <b>usuarios</b>. La clave no se eval√∫a (solo email).</div>
      <div class="login-actions">
        <button class="btn primary" id="btn-do-login">Entrar</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Estado ========= */
const STATE = { empresas:[], usuarios:[], pcs:[], tope:45 };
let CURRENT_USER = null;
let SESSION_EMAIL = "";

/* ========= Helpers ========= */
const qs  = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const money = n => 'S/ ' + Number(n||0).toFixed(2);
function parseMoney(v){
  if(v==null) return 0;
  let s=String(v).trim().replace(/,/g,'.').replace(/[^0-9.\-]/g,'');
  const p=s.split('.'); if(p.length>2){const last=p.pop(); s=p.join('')+'.'+last;}
  const n=parseFloat(s);
  return Number.isFinite(n)?Number(n.toFixed(2)):0;
}
async function api(p,opt={}){ const r=await fetch(p,{headers:{'Content-Type':'application/json'},credentials:'same-origin',...opt}); let d=null; try{d=await r.json();}catch{} if(!r.ok) throw d||{error:r.status}; return d;}

/* ========= Tabs ========= */
qsa('.tab').forEach(b=>b.onclick=()=>{
  qsa('.tab').forEach(x=>x.classList.remove('active')); b.classList.add('active');
  qsa('.view').forEach(v=>v.classList.remove('active')); qs('#view-'+b.dataset.tab).classList.add('active');
  if(b.dataset.tab==='hist') renderHistorial();
  if(b.dataset.tab==='admin') refreshAdminVisibility();
});

/* ========= Login ========= */
async function doLogin(email){
  const u = await api('/api/login?email='+encodeURIComponent(email));
  if(!u || !u.activo) throw new Error('Usuario inactivo');
  SESSION_EMAIL = u.email; localStorage.setItem('planilla_email', u.email);
  CURRENT_USER = u;
  qs('#login-overlay').style.display='none';
  qs('#btn-login').style.display='none'; qs('#btn-logout').style.display='';
  bootAfterLogin();
}
qs('#btn-do-login').onclick = async ()=>{
  try{
    const em = (qs('#login-email').value||'').trim();
    if(!em) return alert('Ingrese su email');
    await doLogin(em);
  }catch(e){ alert(e?.error || e?.message || 'No se pudo iniciar sesi√≥n'); }
};
qs('#btn-login').onclick = ()=>{ qs('#login-overlay').style.display='flex'; };
qs('#btn-logout').onclick = ()=>{ localStorage.removeItem('planilla_email'); location.reload(); };

/* ========= Carga base ========= */
async function bootAfterLogin(){
  // Tope desde backend
  try{ const v=await api('/api/version'); STATE.tope=Number(v?.tope||45); }catch{}
  qs('#pill-tope').textContent = money(STATE.tope);
  qs('#topeLabel').textContent = money(STATE.tope);

  // Emp/Usuarios
  try{ STATE.empresas = await api('/api/empresas?simple=1'); }catch(e){ STATE.empresas=[]; }
  try{ STATE.usuarios = await api('/api/usuarios'); }catch(e){ STATE.usuarios=[]; }

  // Si el servidor entrega activo y empresaid, ya tenemos todo (server.mjs). :contentReference[oaicite:2]{index=2}
  renderHeader();
  llenarTrabajadores();
  await cargarPCsDeEmpresa();
  renderRows(true);
  wireEventsNueva();
  updateAcumuladoYTope();
  renderHistorial();
  refreshAdminVisibility();
}
function renderHeader(){
  if(!CURRENT_USER) return;
  const emp = STATE.empresas.find(e=>e.id===CURRENT_USER.empresaid);
  qs('#emp-razon').textContent = emp?emp.razon:'‚Äî';
  qs('#emp-ruc').textContent   = emp?emp.ruc:'‚Äî';
  qs('#caddr').textContent     = emp?emp.direccion||'':'';
  qs('#p-proy').textContent    = 'PROYECTO PRINCIPAL: ' + (CURRENT_USER.proydef||'‚Äî');
  qs('#who').textContent       = `Conectado: ${CURRENT_USER.nombres} ${CURRENT_USER.apellidos} ‚Äî ${CURRENT_USER.email} ‚Äî Rol: ${CURRENT_USER.rol}`;
}
function llenarTrabajadores(){
  const sel=qs('#sel-trabajador'); sel.innerHTML='';
  STATE.usuarios.filter(u=>u.activo).forEach(u=>{
    const o=document.createElement('option'); o.value=u.email; o.textContent=`${u.nombres} ${u.apellidos}`; sel.appendChild(o);
    if(u.email.toLowerCase()===SESSION_EMAIL.toLowerCase()) o.selected=true;
  });
  sel.onchange = async ()=>{
    const email = sel.value;
    const u = STATE.usuarios.find(x=>x.email.toLowerCase()===email.toLowerCase());
    if(u){ CURRENT_USER=u; renderHeader(); await cargarPCsDeEmpresa(); renderRows(true); updateAcumuladoYTope(); }
  };
}
async function cargarPCsDeEmpresa(){
  if(!CURRENT_USER) return STATE.pcs=[];
  try{ STATE.pcs = await api('/api/pcs?emp='+encodeURIComponent(CURRENT_USER.empresaid)); }catch{ STATE.pcs=[]; }
}

/* ========= Filas ========= */
function newRow(idx, data={}){
  const r=document.createElement('div'); r.className='trow';
  r.innerHTML = `
    <div class="num">${idx}</div>
    <input class="destino uppercase" placeholder="DESTINO" value="${(data.destino||'')}">
    <input class="motivo uppercase"  placeholder="MOTIVO" value="${(data.motivo||'')}">
    <select class="proyecto"></select>
    <select class="pc"></select>
    <input class="monto" placeholder="0.00" inputmode="decimal" value="${data.monto!=null?data.monto:''}">
    <button class="btn ghost small del" title="Eliminar">üóë</button>
  `;
  // proyectos
  const selProy = r.querySelector('.proyecto');
  (CURRENT_USER?.proys||[]).forEach(p=>{
    const o=document.createElement('option'); o.value=p; o.textContent=p; selProy.appendChild(o);
  });
  if(data.proyecto){ selProy.value = data.proyecto; }
  else if(CURRENT_USER?.proydef){ selProy.value=CURRENT_USER.proydef; }

  // PCs
  const selPC = r.querySelector('.pc'); selPC.innerHTML='';
  (STATE.pcs||[]).forEach(c=>{ const o=document.createElement('option'); o.value=c; o.textContent=c; selPC.appendChild(o); });
  if(data.pc) selPC.value=data.pc;

  // eventos
  r.querySelector('.monto').addEventListener('input', recalc);
  r.querySelector('.del').onclick = ()=>{ r.remove(); renumerar(); recalc(); };

  return r;
}
function renderRows(reset=false){
  const box=qs('#rows');
  if(reset) box.innerHTML='';
  if(box.children.length===0){ for(let i=0;i<5;i++) box.appendChild(newRow(i+1)); }
  else renumerar();
}
function renumerar(){
  qsa('#rows .trow').forEach((r,i)=> r.querySelector('.num').textContent=String(i+1));
}
qs('#btn-add-row').onclick = ()=>{ qs('#rows').appendChild(newRow(qsa('#rows .trow').length+1)); };

/* ========= C√°lculos / Tope ========= */
async function updateAcumuladoYTope(){
  const f = qs('#f-emision').value;
  const dni = CURRENT_USER?.dni||'';
  if(!f || !dni){ qs('#pill-acum').textContent=money(0); qs('#pill-disp').textContent=money(STATE.tope); recalc(); return; }
  try{
    const r = await api(`/api/acumulado?dni=${encodeURIComponent(dni)}&fecha=${encodeURIComponent(f)}`);
    const acum = Number(r?.acumulado||0);
    qs('#pill-acum').textContent=money(acum);
    qs('#pill-disp').textContent=money(Math.max(0,STATE.tope - acum));
    recalc(acum);
  }catch{ recalc(); }
}
function recalc(acum=undefined){
  let total=0;
  qsa('#rows .trow').forEach(r=>{ total += parseMoney(r.querySelector('.monto').value); });
  const disp = (acum==null)?(Number(qs('#pill-disp').textContent.replace(/[^\d.]/g,''))||STATE.tope):Math.max(0,STATE.tope - Number(acum||0));
  const over = total > disp + 0.0001;
  qs('#total').textContent = money(total);
  qs('#total').classList.toggle('bad', over);
  qs('#total').classList.toggle('ok', !over);
  qs('#over-alert').style.display = over ? 'block':'none';
  qs('#btn-save').disabled = over || total<=0;
}

/* ========= Nueva: Guardar + PDF ========= */
async function guardarYExportar(){
  if(!CURRENT_USER) return alert('Inicie sesi√≥n.');
  const fecha = qs('#f-emision').value;
  if(!fecha) return alert('Indique la fecha.');

  const items=[];
  qsa('#rows .trow').forEach(r=>{
    const destino=(r.querySelector('.destino').value||'').trim().toUpperCase();
    const motivo =(r.querySelector('.motivo').value ||'').trim().toUpperCase();
    const proyecto=(r.querySelector('.proyecto').value||'').trim().toUpperCase();
    const pc=(r.querySelector('.pc').value||'').trim();
    const monto=parseMoney(r.querySelector('.monto').value);
    if(monto>0) items.push({destino,motivo,proyecto,pc,monto});
  });
  if(!items.length) return alert('Ingrese al menos un √≠tem con monto.');

  const btn=qs('#btn-save'); btn.disabled=true;
  try{
    const res = await api('/api/planillas',{ method:'POST', body: JSON.stringify({ dni:CURRENT_USER.dni, email:SESSION_EMAIL, fecha, items })});
    // El servidor devuelve {serie, num, empresa, u...} y valida el tope/correlativo. :contentReference[oaicite:3]{index=3}
    await exportPDF({ fecha:res.fecha||fecha, items, total:res.total, serie:res.serie, num:res.num, emp:res.empresa, u:res.u||CURRENT_USER });
    alert(`Planilla ${res.serie}-${res.num} guardada y exportada.`);
    renderHistorial();
  }catch(e){
    alert(e?.error||'Error al guardar.');
    console.error(e);
  }finally{ btn.disabled=false; }
}
qs('#btn-save').onclick = guardarYExportar;

/* ========= PDF ========= */
async function exportPDF({ fecha, items, total, serie, num, emp, u }){
  const jsPDFCtor=(window.jspdf&&window.jspdf.jsPDF)||window.jsPDF;
  const doc=new jsPDFCtor({unit:'pt',format:'a4'});
  const razon=(emp&&emp.razon)||'PADOVA', ruc=(emp&&emp.ruc)||'‚Äî';

  doc.setFontSize(12);
  doc.text(razon,40,40);
  doc.text(`R.U.C.: ${ruc}`,40,58);
  doc.setFontSize(14);
  doc.text('PLANILLA DE MOVILIDAD',300,40,{align:'center'});
  doc.text(`Planilla Nro. ${serie}-${num}`,300,58,{align:'center'});

  doc.setFontSize(10);
  const trabajador = `${(u?.nombres||'').toUpperCase()} ${(u?.apellidos||'').toUpperCase()}  DNI: ${u?.dni||''}`;
  doc.text(`Fecha de Emisi√≥n: ${fecha}`,40,90);
  doc.text(`Trabajador: ${trabajador}`,40,108);

  let y=140; const cols=['#','DESTINO','MOTIVO','PROYECTO','PC','MONTO (S/)'], w=[24,120,120,140,60,80];
  const row=(c,yy,h=false)=>{ let x=40; for(let i=0;i<c.length;i++){ doc.rect(x,yy,w[i],22); doc.setFontSize(h?10:9); doc.text(String(c[i]??''),x+3,yy+14); x+=w[i]; } };
  row(cols,y,true); y+=22;
  items.forEach((it,ix)=>{ if(y>760){ doc.addPage(); y=40; } row([ix+1,(it.destino||'').toUpperCase(),(it.motivo||'').toUpperCase(),(it.proyecto||'').toUpperCase(),(it.pc||''),Number(it.monto||0).toFixed(2)], y); y+=22; });
  y+=10; doc.setFontSize(12); doc.text(`Total: S/ ${Number(total||0).toFixed(2)}`,40,y+20);
  doc.save(`${serie}-${num}.pdf`);
}

/* ========= Historial ========= */
async function renderHistorial(){
  const wrap=qs('#hist'); wrap.innerHTML='';
  if(!SESSION_EMAIL) return;
  const all = (CURRENT_USER?.rol||'').toUpperCase().includes('ADMIN') && qs('#hist-all')?.checked ? '&all=1':'';
  let rows=[];
  try{ rows = await api('/api/historial?email='+encodeURIComponent(SESSION_EMAIL)+all); }catch{}
  const tbl=document.createElement('table'); tbl.className='tbl';
  tbl.innerHTML=`<thead><tr>
    <th class="w-s">Serie</th><th class="w-s">N√∫mero</th><th class="w-m">Fecha</th>
    <th class="w-l">Empresa</th><th class="w-m center">Total</th></tr></thead><tbody></tbody>`;
  const tb=tbl.querySelector('tbody');
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.serie}</td><td>${String(r.num).padStart(5,'0')}</td><td>${r.fecha}</td>
                  <td>${r.empresaid}</td><td class="center">${money(r.total)}</td>`;
    tb.appendChild(tr);
  });
  wrap.appendChild(tbl);

  const isAdmin=(CURRENT_USER?.rol||'').toUpperCase().includes('ADMIN');
  qs('#hist-admin-actions').style.display = isAdmin?'flex':'none';
}
qs('#hist-all')?.addEventListener('change', renderHistorial);

/* ========= Admin ========= */
function refreshAdminVisibility(){
  const isAdmin=(CURRENT_USER?.rol||'').toUpperCase().includes('ADMIN');
  qs('#tab-admin').style.display = isAdmin?'inline-flex':'none';
  qs('#btn-new-worker').disabled = !isAdmin;
  qs('#btn-edit-worker').disabled = !isAdmin;
}
let ADMIN_PIN_OK = false;
qs('#btn-admin-pin').onclick = async ()=>{
  try{
    const pin = qs('#pin-in').value;
    const r = await api('/api/admin/pin',{method:'POST',body:JSON.stringify({pin})});
    if(r.ok){ ADMIN_PIN_OK=true; qs('#pin-ok').textContent='PIN v√°lido'; await cargarTablasAdmin(); }
  }catch(e){ alert(e?.error||'PIN inv√°lido'); }
};
async function cargarTablasAdmin(){
  const emp = await api('/api/empresas');
  const usr = await api('/api/usuarios');
  renderEmpresasAdmin(emp); renderUsuariosAdmin(usr);
  qs('#emp-add').disabled = qs('#emp-save').disabled = qs('#usr-add').disabled = qs('#usr-save').disabled = false;
}
function renderEmpresasAdmin(list){
  const host=qs('#emp-table'); host.innerHTML='';
  const tbl=document.createElement('table'); tbl.className='tbl';
  tbl.innerHTML=`<thead><tr><th>ID</th><th>Raz√≥n</th><th>RUC</th><th>Direcci√≥n</th><th>Tel√©fono</th><th>Logo (base64)</th></tr></thead><tbody></tbody>`;
  const tb=tbl.querySelector('tbody');
  (list||[]).forEach(e=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td contenteditable>${e.id||''}</td><td contenteditable>${e.razon||''}</td>
      <td contenteditable>${e.ruc||''}</td><td contenteditable>${e.direccion||''}</td>
      <td contenteditable>${e.telefono||''}</td><td contenteditable>${e.logo||''}</td>`;
    tb.appendChild(tr);
  });
  host.appendChild(tbl);
  qs('#emp-add').onclick=()=>{ const tr=document.createElement('tr'); tr.innerHTML='<td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td>'; tb.appendChild(tr); };
  qs('#emp-save').onclick=async ()=>{
    const pin=qs('#pin-in').value; const empresas=[];
    tb.querySelectorAll('tr').forEach(tr=>{
      const t=tr.querySelectorAll('td'); empresas.push({id:t[0].innerText.trim(),razon:t[1].innerText.trim(),ruc:t[2].innerText.trim(),direccion:t[3].innerText.trim(),telefono:t[4].innerText.trim(),logo:t[5].innerText.trim()||null});
    });
    await fetch('/api/admin/empresas',{method:'PUT',headers:{'Content-Type':'application/json','x-admin-pin':pin},body:JSON.stringify({empresas})});
    alert('Empresas guardadas');
  };
}
function renderUsuariosAdmin(list){
  const host=qs('#usr-table'); host.innerHTML='';
  const tbl=document.createElement('table'); tbl.className='tbl';
  tbl.innerHTML=`<thead><tr>
    <th>Email</th><th class="w-s">DNI</th><th>Nombres</th><th>Apellidos</th><th class="w-s">Rol</th>
    <th class="w-s">Activo(1/0)</th><th class="w-s">EmpresaID</th><th>ProyDef</th><th>Proys (coma)</th></tr></thead><tbody></tbody>`;
  const tb=tbl.querySelector('tbody');
  (list||[]).forEach(u=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td contenteditable>${u.email||''}</td><td contenteditable>${u.dni||''}</td><td contenteditable>${u.nombres||''}</td>
      <td contenteditable>${u.apellidos||''}</td><td contenteditable>${u.rol||''}</td>
      <td contenteditable>${u.activo?'1':'0'}</td><td contenteditable>${u.empresaid||''}</td>
      <td contenteditable>${u.proydef||''}</td><td contenteditable>${(u.proys||[]).join(', ')}</td>`;
    tb.appendChild(tr);
  });
  host.appendChild(tbl);
  qs('#usr-add').onclick=()=>{ const tr=document.createElement('tr'); tr.innerHTML='<td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable></td><td contenteditable>USUARIO</td><td contenteditable>1</td><td contenteditable></td><td contenteditable></td><td contenteditable></td>'; tb.appendChild(tr); };
  qs('#usr-save').onclick=async ()=>{
    const pin=qs('#pin-in').value; const usuarios=[];
    tb.querySelectorAll('tr').forEach(tr=>{
      const t=tr.querySelectorAll('td');
      usuarios.push({
        email:t[0].innerText.trim(), dni:t[1].innerText.trim(), nombres:t[2].innerText.trim(), apellidos:t[3].innerText.trim(),
        rol:t[4].innerText.trim(), activo:t[5].innerText.trim(), empresaid:t[6].innerText.trim(), proydef:t[7].innerText.trim(),
        proys:(t[8].innerText||'').split(',').map(x=>x.trim()).filter(Boolean)
      });
    });
    await fetch('/api/admin/usuarios',{method:'PUT',headers:{'Content-Type':'application/json','x-admin-pin':pin},body:JSON.stringify({usuarios})});
    alert('Usuarios guardados');
    STATE.usuarios = await api('/api/usuarios'); llenarTrabajadores();
  };
}

/* ========= Arranque ========= */
window.addEventListener('DOMContentLoaded', async ()=>{
  const em = localStorage.getItem('planilla_email')||'';
  if(em){ qs('#login-email').value=em; }
  // Fecha por defecto: hoy
  const today = new Date(); const yyyy=today.getFullYear(); const mm=String(today.getMonth()+1).padStart(2,'0'); const dd=String(today.getDate()).padStart(2,'0');
  qs('#f-emision').value = `${yyyy}-${mm}-${dd}`;
  qs('#f-emision').addEventListener('change', updateAcumuladoYTope);
  // Forzar login cada vez
  qs('#login-overlay').style.display='flex';
});
function wireEventsNueva(){
  qsa('#rows input, #rows select').forEach(el=> el.addEventListener('change', ()=> recalc() ));
  recalc();
}
</script>
</body>
</html>