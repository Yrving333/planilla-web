<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Planilla de Movilidad</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--fg:#0f172a;--muted:#667085;--primary:#2563eb;--bg:#f8fafc;--card:#fff;--border:#e5e7eb}
  *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--fg)}
  .container{max-width:1100px;margin:24px auto;padding:0 16px}
  header{display:flex;align-items:center;gap:14px;margin-bottom:16px}
  header .who{font-size:12px;color:var(--muted)} header .who b{color:var(--fg)}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px}
  h2{margin:0 0 6px 0;font-size:18px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .muted{color:var(--muted)}
  input,select,button{height:40px;border:1px solid var(--border);border-radius:8px;padding:0 10px;font:inherit}
  button.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .row{display:flex;gap:10px;align-items:center}
  .logo{height:36px;object-fit:contain}
  nav{display:flex;gap:16px;margin:12px 0 16px 0}
  nav a{color:var(--muted);text-decoration:none;padding:8px 0;border-bottom:2px solid transparent}
  nav a.active{color:var(--primary);border-color:var(--primary)}
  .hide{display:none}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
</style>
</head>
<body>
<div class="container">

  <header>
    <img id="empLogo" class="logo" src="" alt="">
    <div>
      <div class="who">Conectado: <b id="whoName">—</b> — <span id="whoMail">—</span> — Rol: <span id="whoRol">—</span></div>
      <div class="muted" id="empHeader">— • R.U.C. —</div>
    </div>
  </header>

  <nav>
    <a href="#" id="tabNew" class="active">Nueva Planilla</a>
    <a href="#" id="tabHist">Historial</a>
    <a href="#" id="tabAdmin" class="">Ajustes (Admin)</a>
  </nav>

  <!-- NUEVA PLANILLA -->
  <section id="secNew" class="card">
    <h2>PLANILLA DE MOVILIDAD</h2>
    <div class="muted">PROYECTO PRINCIPAL: <b id="projectTitle">—</b></div>
    <div class="grid2" style="margin-top:10px">
      <div>
        <label class="muted">Fecha de Emisión</label>
        <input id="fechEmi" type="date">
      </div>
      <div>
        <label class="muted">Trabajador Seleccionado</label>
        <select id="selTrab"></select>
      </div>
    </div>

    <div style="margin:16px 0 8px 0" class="muted">
      Serie: <b id="serieLbl">—</b> · DNI: <b id="dniLbl">—</b>
    </div>

    <div id="rows"></div>

    <div class="row" style="justify-content:space-between;margin-top:12px">
      <div class="muted">Tope por día: S/ 45.00 · Acumulado día: <span id="acumDia">S/ 0.00</span></div>
      <button class="primary" id="btnSend">Finalizar, Guardar y Exportar a PDF</button>
    </div>
  </section>

  <!-- HISTORIAL (solo lista simple) -->
  <section id="secHist" class="card hide">
    <h2>Historial</h2>
    <div id="histList" class="muted">—</div>
  </section>

  <!-- AJUSTES ADMIN -->
  <section id="secAdmin" class="card hide">
    <h2>Ajustes (Admin)</h2>

    <h3>Empresas</h3>
    <div id="empTable"></div>
    <div class="row" style="margin-top:8px"><button id="saveEmp" class="primary">Guardar empresas</button></div>

    <h3 style="margin-top:18px">Usuarios</h3>
    <div id="usrTable"></div>
    <div class="row" style="margin-top:8px"><button id="saveUsr" class="primary">Guardar usuarios</button></div>
  </section>

</div>

<script>
  // ------ Helpers ------
  const API = location.origin;
  function fmt(n){return "S/ " + (Number(n||0)).toFixed(2)}
  function serieFrom(n,a){return (n.slice(0,2)+(a||"").slice(0,2)).toUpperCase()+"001"}

  // ------ Auth (simple modal inline) ------
  let token = localStorage.getItem("token") || "";
  async function loginFlow(){
    if (token) { try { await loadMe(); return } catch{} }
    const email = prompt("Email demo:\nadmin@empresa.com o usuario@empresa.com") || "";
    const pass  = prompt("Clave demo:\nadmin123 o usuario123") || "";
    const r = await fetch(API+"/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email,password:pass})});
    const j = await r.json();
    if(!r.ok){ alert(j.error||"Login fallo"); return loginFlow() }
    token = j.token; localStorage.setItem("token", token);
    me = j.me;
    applyMe(me);
    await initAfterAuth();
  }

  // ------ Estado global ------
  let me = null;
  let empresas = [];
  let usuarios = [];

  async function loadMe(){
    const r = await fetch(API+"/api/me",{headers:{Authorization:"Bearer "+token}});
    if(!r.ok) throw new Error("Auth");
    me = await r.json();
    applyMe(me);
  }

  function applyMe(m){
    // cabecera
    document.getElementById("whoName").textContent = `${m.nombres} ${m.apellidos}`;
    document.getElementById("whoMail").textContent = m.email;
    document.getElementById("whoRol").textContent  = m.rol;
    document.getElementById("projectTitle").textContent = m.proyDef||"—";

    const e = m.empresa || {};
    const head = `${e.razon||"—"} • R.U.C. ${e.ruc||"—"} • ${e.direccion||""}`;
    document.getElementById("empHeader").textContent = head;
    const logo = document.getElementById("empLogo");
    if(e.logo){ logo.src = e.logo; logo.classList.remove("hide"); } else { logo.src=""; logo.classList.add("hide"); }

    document.getElementById("serieLbl").textContent = m.serieBase || serieFrom(m.nombres, m.apellidos);
    document.getElementById("dniLbl").textContent   = m.dni || "—";
  }

  // ------ Carga inicial después de auth ------
  async function initAfterAuth(){
    // empresas y usuarios (para admin y selector trabajador)
    const [re, ru] = await Promise.all([
      fetch(API+"/api/empresas",{headers:{Authorization:"Bearer "+token}}),
      fetch(API+"/api/usuarios",{headers:{Authorization:"Bearer "+token}})
    ]);
    empresas = await re.json();
    usuarios = await ru.json();

    renderSelectTrab();
    renderRows();
    renderAdmin();

    // pestañas
    const tabNew = document.getElementById("tabNew");
    const tabHist= document.getElementById("tabHist");
    const tabAdm = document.getElementById("tabAdmin");
    tabAdm.style.display = (me.rol==="ADMIN_PADOVA") ? "inline-block":"none";

    tabNew.onclick = (e)=>{e.preventDefault();show("New")};
    tabHist.onclick= (e)=>{e.preventDefault();show("Hist")};
    tabAdm.onclick = (e)=>{e.preventDefault();show("Admin")};

    // eventos
    document.getElementById("selTrab").onchange = onChangeTrab;
    document.getElementById("btnSend").onclick  = sendPlanilla;
    document.getElementById("saveEmp").onclick  = saveEmpresas;
    document.getElementById("saveUsr").onclick  = saveUsuarios;
  }

  function show(which){
    for(const id of ["New","Hist","Admin"]){
      document.getElementById("sec"+id).classList.toggle("hide", id!==which);
      document.getElementById("tab"+id).classList.toggle("active", id===which);
    }
  }

  function renderSelectTrab(){
    const sel = document.getElementById("selTrab");
    sel.innerHTML = usuarios.map(u=>{
      return `<option value="${u.id}" ${u.id===me.id?"selected":""}>${u.nombres} ${u.apellidos}</option>`;
    }).join("");
    // No agregamos íconos de crear/editar aquí (requerimiento)
  }

  function renderRows(){
    const box = document.getElementById("rows");
    const pcs = ["94303","95301","95303","234120502","234120503"]
      .map(p=>`<option value="${p}">${p}</option>`).join("");
    let html = "";
    for(let i=0;i<5;i++){
      html += `
      <div class="grid2" style="margin-top:8px">
        <input placeholder="DESTINO">
        <div class="grid2">
          <input placeholder="MOTIVO">
          <select>${pcs}</select>
        </div>
      </div>`;
    }
    box.innerHTML = html;
  }

  async function onChangeTrab(){
    const id = Number(this.value);
    const u = usuarios.find(x=>x.id===id);
    if(!u) return;
    // recalcular cabecera
    me = {
      ...me,
      id: u.id, email: u.email, rol: u.rol, dni: u.dni,
      nombres: u.nombres, apellidos:u.apellidos,
      empresaId: u.empresaid, proyDef: u.proydef||"",
      serieBase: serieFrom(u.nombres, u.apellidos),
      empresa: empresas.find(e=>e.id===u.empresaid)||me.empresa
    };
    applyMe(me);
  }

  // ------ Guardar planilla ------
  async function sendPlanilla(){
    // leer 5 filas (simple)
    const filas = Array.from(document.querySelectorAll("#rows .grid2"));
    const detalles = filas.map((row,idx)=>{
      const [dest,div] = row.children;
      const [mot,pc] = div.children;
      return {
        destino: dest.value.trim(),
        motivo: mot.value.trim(),
        proyecto: me.proyDef || "",
        pc: pc.value,
        monto: Number(0) // la UI simple no incluye montos en este layout
      }
    });

    const fecha = document.getElementById("fechEmi").value || new Date().toISOString().slice(0,10);

    const r = await fetch(API+"/api/planillas",{
      method:"POST",
      headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},
      body: JSON.stringify({ dni: me.dni, fecha, detalles })
    });
    const j = await r.json();
    if(!r.ok){ alert(j.error||"Error"); return; }
    alert(`Guardado: ${j.serie}-${j.num} · Total ${fmt(j.total)}`);
  }

  // ------ Admin ------
  function renderAdmin(){
    // Empresas
    const empTbl = `
      <table>
        <thead><tr><th>ID</th><th>Razón</th><th>RUC</th><th>Dirección</th><th>Teléfono</th><th>Logo (URL)</th></tr></thead>
        <tbody>
          ${empresas.map(e=>`
            <tr>
              <td><input value="${e.id}" data-t="emp" data-id="${e.id}" data-f="id" disabled></td>
              <td><input value="${e.razon||""}" data-t="emp" data-id="${e.id}" data-f="razon"></td>
              <td><input value="${e.ruc||""}" data-t="emp" data-id="${e.id}" data-f="ruc"></td>
              <td><input value="${e.direccion||""}" data-t="emp" data-id="${e.id}" data-f="direccion"></td>
              <td><input value="${e.telefono||""}" data-t="emp" data-id="${e.id}" data-f="telefono"></td>
              <td><input value="${e.logo||""}" data-t="emp" data-id="${e.id}" data-f="logo"></td>
            </tr>`).join("")}
        </tbody>
      </table>`;
    document.getElementById("empTable").innerHTML = empTbl;

    // Usuarios (ahora SÍ guardará dni, empresaId y proyDef)
    const empOpts = empresas.map(e=>`<option value="${e.id}">${e.id}</option>`).join("");
    const usrTbl = `
      <table>
        <thead><tr>
          <th>Activo</th><th>DNI</th><th>Nombres</th><th>Apellidos</th>
          <th>Email</th><th>Empresa</th><th>Rol</th><th>Proy. Defecto</th><th>Proyectos (coma)</th>
        </tr></thead>
        <tbody>
          ${usuarios.map(u=>`
          <tr>
            <td><input type="checkbox" ${u.activo===1?"checked":""} data-t="usr" data-id="${u.id}" data-f="activo"></td>
            <td><input value="${u.dni||""}" data-t="usr" data-id="${u.id}" data-f="dni"></td>
            <td><input value="${u.nombres||""}" data-t="usr" data-id="${u.id}" data-f="nombres"></td>
            <td><input value="${u.apellidos||""}" data-t="usr" data-id="${u.id}" data-f="apellidos"></td>
            <td><input value="${u.email||""}" data-t="usr" data-id="${u.id}" data-f="email"></td>
            <td>
              <select data-t="usr" data-id="${u.id}" data-f="empresaId">
                ${empOpts.replace(`value="${u.empresaid}"`,`value="${u.empresaid}" selected`)}
              </select>
            </td>
            <td>
              <select data-t="usr" data-id="${u.id}" data-f="rol">
                <option value="USUARIO" ${u.rol==="USUARIO"?"selected":""}>USUARIO</option>
                <option value="ADMIN_PADOVA" ${u.rol==="ADMIN_PADOVA"?"selected":""}>ADMIN_PADOVA</option>
              </select>
            </td>
            <td><input value="${u.proydef||""}" data-t="usr" data-id="${u.id}" data-f="proyDef"></td>
            <td><input value="${u.proyectos||""}" data-t="usr" data-id="${u.id}" data-f="proyectos"></td>
          </tr>`).join("")}
        </tbody>
      </table>`;
    document.getElementById("usrTable").innerHTML = usrTbl;
  }

  function collect(tableSelector){
    const inputs = Array.from(document.querySelectorAll(`${tableSelector} [data-t]`));
    const map = new Map();
    for(const el of inputs){
      const t = el.dataset.t, id = el.dataset.id, f = el.dataset.f;
      const val = el.type==="checkbox" ? (el.checked?1:0) : el.value;
      const key = `${t}:${id}`;
      if(!map.has(key)) map.set(key,{ id:Number(id) });
      map.get(key)[f] = val;
    }
    return Array.from(map.values());
  }

  async function saveEmpresas(){
    const rows = collect("#empTable");
    const r = await fetch(API+"/api/empresas",{
      method:"PUT",
      headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},
      body: JSON.stringify(rows)
    });
    const j = await r.json();
    if(!r.ok){ alert(j.error||"Error"); return; }
    alert("Empresas guardadas");
  }

  async function saveUsuarios(){
    const rows = collect("#usrTable").map(u=>({
      ...u,
      activo: Number(u.activo||0),
    }));
    const r = await fetch(API+"/api/usuarios",{
      method:"PUT",
      headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},
      body: JSON.stringify(rows)
    });
    const j = await r.json();
    if(!r.ok){ alert(j.error||"Error"); return; }
    alert("Usuarios guardados");
  }

  // ------ start ------
  (async ()=>{
    await loginFlow();
    if(!me){ await loadMe(); }
    await initAfterAuth();
  })();
</script>
</body>
</html>