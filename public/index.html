<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Planilla de Movilidad — S/45</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{--primary:#2563eb;--ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--bg:#f1f5f9;--card:#fff;--ok:#16a34a;--bad:#ef4444}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);font-family:Inter,system-ui,sans-serif;color:var(--ink)}
  .wrap{max-width:1080px;margin:16px auto;padding:0 14px}
  .bar{display:flex;justify-content:space-between;align-items:center;margin:4px 0 12px}
  .who{font-size:.9rem;color:var(--muted)}
  .btn{border:1px solid var(--line);background:#fff;padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
  .btn.p{background:var(--primary);border-color:var(--primary);color:#fff}
  .tabs{display:flex;gap:8px;margin-bottom:10px}
  .tab{padding:10px 14px;border:none;background:transparent;border-bottom:2px solid transparent;cursor:pointer;font-weight:700;color:var(--muted)}
  .tab.act{color:var(--primary);border-bottom-color:var(--primary)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 8px 24px rgba(2,8,23,.06);margin-bottom:14px}
  .h{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
  .b{padding:16px 18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .group label{display:block;font-size:.9rem;font-weight:700;margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .thead,.row{display:grid;grid-template-columns:34px 1.2fr 1.2fr 1fr .7fr .8fr .5fr;gap:8px;align-items:center}
  .thead{font-size:.74rem;color:var(--muted);text-transform:uppercase;margin-bottom:6px}
  .row{margin:6px 0}
  .num{text-align:center;color:var(--muted);font-weight:900}
  .sum{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center;padding:10px;background:#f8fafc;border-top:1px solid var(--line)}
  .pill{border:1px solid var(--line);border-radius:999px;padding:4px 8px;font-size:.8rem;color:var(--muted);background:#fff}
  .amt{font-weight:900}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .alert{display:none;margin-top:10px;background:#fee2e2;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px}
  .login{position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center}
  .modal{background:#fff;padding:16px;border-radius:14px;min-width:320px}
  .text-right{text-align:right}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <div class="who" id="who">No autenticado</div>
    <div>
      <button class="btn" id="btn-logout" style="display:none">Cerrar sesión</button>
      <button class="btn p" id="btn-login">Iniciar sesión</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab act" data-tab="new">Nueva Planilla</button>
    <button class="tab" data-tab="hist">Historial</button>
    <button class="tab" data-tab="admin" id="tab-admin" style="display:none">Ajustes (Admin)</button>
  </div>

  <!-- Nueva -->
  <div class="card view" id="view-new" style="display:block">
    <div class="h">
      <div>
        <div style="font-weight:800;text-align:center">PLANILLA DE MOVILIDAD</div>
        <div id="proj" style="text-align:center;color:#1d4ed8;font-weight:800;font-size:.95rem">PROYECTO PRINCIPAL: —</div>
      </div>
      <div class="text-right" style="font-size:.9rem;color:#475569">
        <div id="emp-razon"><b>—</b></div>
        <div>R.U.C. <span id="emp-ruc">—</span></div>
        <div id="emp-dir"></div>
        <div id="emp-tel"></div>
      </div>
    </div>
    <div class="b">
      <div class="grid">
        <div class="group"><label>Fecha de Emisión</label><input type="date" id="f-emision"/></div>
        <div class="group"><label>Trabajador Seleccionado</label>
          <div style="display:flex;gap:6px">
            <select id="sel-user" style="flex:1"></select>
            <button class="btn" id="btn-add-row" title="Agregar fila">+</button>
          </div>
        </div>
      </div>

      <div class="thead" style="margin-top:10px">
        <div>#</div><div>Destino</div><div>Motivo</div><div>Proyecto</div><div>PC</div><div>Monto (S/)</div><div></div>
      </div>
      <div id="rows"></div>

      <div class="alert" id="alert-top">Has superado el tope disponible del día.</div>

      <div class="sum">
        <span class="pill">Tope por día: <b>S/ <span id="pill-tope">45.00</span></b></span>
        <span class="pill">Acumulado día: <b>S/ <span id="pill-acc">0.00</span></b></span>
        <span class="pill">Disponible: <b>S/ <span id="pill-disp">45.00</span></b></span>
        <span>Total:</span>
        <span class="amt ok" id="sum-total">S/ 0.00</span>
      </div>
    </div>
    <div class="b">
      <button class="btn p" id="btn-save">Finalizar, Guardar y Exportar a PDF</button>
    </div>
  </div>

  <!-- Historial -->
  <div class="card view" id="view-hist" style="display:none">
    <div class="h"><b>Historial</b></div>
    <div class="b">
      <div id="hist"></div>
    </div>
  </div>

  <!-- Admin -->
  <div class="card view" id="view-admin" style="display:none">
    <div class="h"><b>Acceso administrador</b></div>
    <div class="b">
      <div style="display:flex;gap:6px;align-items:center">
        <input type="password" id="pin" placeholder="PIN admin"/>
        <button class="btn p" id="btn-pin">Ingresar</button>
        <span id="pin-ok" style="color:#16a34a;font-weight:700"></span>
      </div>
    </div>

    <div class="h"><b>Empresas</b>
      <div>
        <button class="btn" id="emp-save" disabled>Guardar</button>
      </div>
    </div>
    <div class="b"><div id="emp-table"></div></div>

    <div class="h"><b>Usuarios</b>
      <div>
        <button class="btn" id="usr-save" disabled>Guardar</button>
      </div>
    </div>
    <div class="b"><div id="usr-table"></div></div>
  </div>
</div>

<!-- Login -->
<div class="login" id="login" style="display:none">
  <div class="modal">
    <h3>Iniciar sesión</h3>
    <div class="group"><label>Email</label><input type="email" id="login-email" placeholder="admin@empresa.com"/></div>
    <div class="group" style="margin-top:8px"><label>Clave</label><input type="password" id="login-pass" placeholder="******"/></div>
    <div style="color:#64748b;font-size:.85rem;margin-top:6px">Se valida contra la tabla <b>usuarios</b> (solo el email).</div>
    <div class="text-right" style="margin-top:10px">
      <button class="btn p" id="login-ok">Entrar</button>
    </div>
  </div>
</div>

<script>
const S = { empresas:[], usuarios:[], pcs:[], user:null, tope:45, acc:0 };
const qs = (s)=>document.querySelector(s);
const qsa=(s)=>Array.from(document.querySelectorAll(s));
const money=(n)=>Number((+n||0).toFixed(2));
const fm=(n)=>'S/ '+money(n).toFixed(2);
const pad=(n)=>String(n).padStart(5,'0');

async function api(p, opt={}) {
  const r = await fetch(p, { headers:{'Content-Type':'application/json'}, credentials:'same-origin', ...opt });
  let d=null; try{ d=await r.json(); }catch(_){}
  if(!r.ok) throw new Error(d?.error||d?.msg||('HTTP '+r.status));
  return d;
}

// UI helpers
function setTabs() {
  qsa('.tab').forEach(t=>{
    t.onclick=()=>{
      qsa('.tab').forEach(e=>e.classList.remove('act'));
      t.classList.add('act');
      qsa('.view').forEach(v=>v.style.display='none');
      qs('#view-'+t.dataset.tab).style.display='block';
      if(t.dataset.tab==='hist') renderHistorial();
    };
  });
}

function showLogin(v=true){ qs('#login').style.display = v?'flex':'none'; }
function setWho(){
  if(!S.user){ qs('#who').textContent='No autenticado'; return; }
  const u=S.user;
  qs('#who').textContent = `Conectado: ${u.nombres} ${u.apellidos} — ${u.email} — DNI: ${u.dni} — Rol: ${u.rol}`;
}

// Data
async function loadBase() {
  // empresas, usuarios, pcs y tope
  S.empresas = await api('/api/empresas');
  S.usuarios = await api('/api/usuarios');
  S.pcs = await api('/api/pcs');
  S.tope = 45; // del backend también vendrá en POST, pero aquí lo mostramos
  qs('#pill-tope').textContent = S.tope.toFixed(2);

  // intentar sesión previa
  let email = localStorage.getItem('planilla_email') || '';
  if(email){
    try{ S.user = await api('/api/login?email='+encodeURIComponent(email)); }catch(_){}
  }
  if(!S.user){
    showLogin(true);
  } else {
    afterLogin();
  }
}

function fillHeaderByEmpresa() {
  const emp = S.user?.empresa || null;
  qs('#emp-razon').innerHTML = `<b>${emp?.razon||'—'}</b>`;
  qs('#emp-ruc').textContent = emp?.ruc || '—';
  qs('#emp-dir').textContent = emp?.direccion || '';
  qs('#emp-tel').textContent = emp?.telefono || '';
  qs('#proj').textContent = 'PROYECTO PRINCIPAL: ' + (S.user?.proydef||'—');
}

function fillUsersSelect() {
  const sel = qs('#sel-user');
  sel.innerHTML = '';
  S.usuarios.filter(u=>u.activo).forEach(u=>{
    const o=document.createElement('option');
    o.value=u.email;
    o.textContent=`${u.nombres} ${u.apellidos}`;
    if(S.user && u.email.toLowerCase()===S.user.email.toLowerCase()) o.selected=true;
    sel.appendChild(o);
  });
  sel.onchange = async ()=>{
    const email = sel.value;
    S.user = await api('/api/login?email='+encodeURIComponent(email));
    localStorage.setItem('planilla_email', S.user.email);
    setWho(); fillHeaderByEmpresa(); renderRows(); calcAcc(); 
    if(S.user.rol==='ADMIN_PADOVA') qs('#tab-admin').style.display='inline-block';
  };
}

function rowTemplate(i, it={}){
  const proys = (S.user?.proyectos || []);
  const pcOpts = S.pcs.map(p=>`<option value="${p.pc}">${p.pc}</option>`).join('');
  const prj = proys.map(p=>`<option value="${p}">${p}</option>`).join('');
  return `
    <div class="row" data-i="${i}">
      <div class="num">${i+1}</div>
      <div><input class="destino" value="${it.destino||''}"/></div>
      <div><input class="motivo" value="${it.motivo||''}"/></div>
      <div><select class="proyecto"><option value="">—</option>${prj}</select></div>
      <div><select class="pc">${pcOpts}</select></div>
      <div><input class="monto" inputmode="decimal" value="${(it.monto||0)}"/></div>
      <div><button class="btn btn-del" title="Eliminar">🗑️</button></div>
    </div>`;
}

function renderRows() {
  const cont = qs('#rows');
  cont.innerHTML = '';
  for(let i=0;i<5;i++) cont.insertAdjacentHTML('beforeend', rowTemplate(i));
  cont.querySelectorAll('.proyecto').forEach(sel=>{
    if(S.user?.proydef) sel.value = S.user.proydef;
  });
  wireRows();
  calcTotal();
}

function wireRows(){
  qs('#btn-add-row').onclick = ()=>{
    const i = qsa('#rows .row').length;
    qs('#rows').insertAdjacentHTML('beforeend', rowTemplate(i));
    wireRows(); calcTotal();
  };
  qsa('#rows .btn-del').forEach(btn=>{
    btn.onclick = (ev)=>{
      ev.currentTarget.closest('.row').remove();
      // reindex
      qsa('#rows .row').forEach((r,idx)=>r.querySelector('.num').textContent=idx+1);
      calcTotal();
    };
  });
  qsa('#rows input, #rows select').forEach(el=>{
    el.oninput = calcTotal;
    el.onchange = calcTotal;
  });
}

function getItems(){
  const items=[];
  qsa('#rows .row').forEach(r=>{
    const destino = r.querySelector('.destino')?.value.trim().toUpperCase();
    const motivo = r.querySelector('.motivo')?.value.trim().toUpperCase();
    const proyecto = r.querySelector('.proyecto')?.value.trim().toUpperCase();
    const pc = r.querySelector('.pc')?.value.trim();
    const monto = Number(r.querySelector('.monto')?.value||0);
    if(monto>0) items.push({destino,motivo,proyecto,pc,monto});
  });
  return items;
}

async function calcAcc(){
  if(!S.user) return;
  const f = qs('#f-emision').value || '';
  if(!f){ S.acc=0; updateSums(); return; }
  try{
    const r = await api(`/api/acumulado?dni=${encodeURIComponent(S.user.dni)}&fecha=${encodeURIComponent(f)}`);
    S.acc = Number(r.acc||0);
    updateSums();
  }catch(_){ S.acc=0; updateSums(); }
}

function calcTotal(){
  const items = getItems();
  const total = items.reduce((a,it)=>a + money(it.monto), 0);
  S.total = money(total);
  updateSums();
}

function updateSums(){
  const disp = money(S.tope - S.acc);
  qs('#pill-acc').textContent = S.acc.toFixed(2);
  qs('#pill-disp').textContent = disp.toFixed(2);
  qs('#sum-total').textContent = fm(S.total);
  const alert = qs('#alert-top');
  if(S.total > disp){ alert.style.display='block'; qs('#sum-total').classList.remove('ok'); qs('#sum-total').classList.add('bad'); }
  else { alert.style.display='none'; qs('#sum-total').classList.add('ok'); qs('#sum-total').classList.remove('bad'); }
}

// Guardar + PDF
async function guardar(){
  if(!S.user){ alert('Inicia sesión'); return; }
  const fecha = qs('#f-emision').value || '';
  const items = getItems();
  if(!fecha){ alert('Configura la fecha.'); return; }
  if(!items.length){ alert('Ingresa al menos un ítem con monto.'); return; }

  const btn = qs('#btn-save'); btn.disabled=true;
  try{
    const r = await api('/api/planillas', { method:'POST', body: JSON.stringify({
      dni:S.user.dni, email:S.user.email, fecha, items
    })});
    await exportPDF(r, items);
    alert(`Planilla ${r.numero} guardada y exportada.`);
    calcAcc();
  }catch(e){
    alert(e.message||'Error al guardar');
  }finally{ btn.disabled=false; }
}

async function exportPDF(info, items){
  const jsPDFCtor = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
  const doc = new jsPDFCtor({ unit:'pt', format:'a4' });
  const emp = info.empresa||{};
  const u = info.usuario||S.user||{};
  doc.setFontSize(12);
  doc.text(emp.razon||'',40,40);
  doc.text(`R.U.C.: ${emp.ruc||''}`,40,58);
  doc.setFontSize(14);
  doc.text('PLANILLA DE MOVILIDAD',300,40,{align:'center'});
  doc.text(`Planilla Nro. ${info.numero}`,300,58,{align:'center'});
  doc.setFontSize(10);
  doc.text(`Fecha de Emisión: ${info.fecha}`,40,90);
  doc.text(`Trabajador: ${(u.nombres||'').toUpperCase()} ${(u.apellidos||'').toUpperCase()}  DNI: ${u.dni||''}`,40,108);
  // tabla
  let y=140;
  const cols=['#','DESTINO','MOTIVO','PROYECTO','PC','MONTO (S/)'];
  const w=[24,120,120,140,60,80];
  const row=(c,yy,h=false)=>{ let x=40; for(let i=0;i<c.length;i++){ doc.rect(x,yy,w[i],22); doc.setFontSize(h?10:9); doc.text(String(c[i]??''),x+3,yy+14); x+=w[i]; } };
  row(cols,y,true); y+=22;
  items.forEach((it,ix)=>{ if(y>760){ doc.addPage(); y=40; }
    row([ix+1,(it.destino||''),(it.motivo||''),(it.proyecto||''),(it.pc||''), money(it.monto).toFixed(2)], y);
    y+=22;
  });
  y+=10; doc.setFontSize(12);
  doc.text(`Total: S/ ${money(info.total).toFixed(2)}`,40,y+20);
  doc.save(`${info.numero}.pdf`);
}

// Historial
async function renderHistorial(){
  if(!S.user) return;
  const data = await api(`/api/historial?email=${encodeURIComponent(S.user.email)}&rol=${encodeURIComponent(S.user.rol)}`);
  const cont = qs('#hist'); cont.innerHTML='';
  if(!data.length){ cont.innerHTML='<i>Sin registros</i>'; return; }
  const rows = data.map(r=>`<tr>
    <td>${r.numero}</td><td>${r.fecha}</td><td>${r.razon||''}</td><td>${r.dni}</td><td class="text-right">${money(r.total).toFixed(2)}</td>
  </tr>`).join('');
  cont.innerHTML = `<div class="table-wrap">
    <table style="width:100%;border-collapse:collapse">
      <thead><tr style="background:#f8fafc"><th>Planilla</th><th>Fecha</th><th>Empresa</th><th>DNI</th><th class="text-right">Total</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  </div>`;
}

// Admin (simple)
let adminOK = false;
qs('#btn-pin').onclick = async ()=>{
  try{
    await api('/api/admin/pin',{method:'POST',body:JSON.stringify({pin:qs('#pin').value})});
    adminOK=true; qs('#pin-ok').textContent='PIN válido';
    qs('#emp-save').disabled=false; qs('#usr-save').disabled=false;
    renderAdminTables();
  }catch(e){ alert('PIN inválido'); }
};

async function renderAdminTables(){
  if(!adminOK) return;
  const emp = await api('/api/admin/empresas');
  const usr = await api('/api/admin/usuarios');

  qs('#emp-table').innerHTML = `
  <div class="table-wrap"><table style="width:100%;border-collapse:collapse">
    <thead><tr style="background:#f8fafc"><th>ID</th><th>Razón</th><th>RUC</th><th>Dirección</th><th>Teléfono</th></tr></thead>
    <tbody>${emp.map(e=>`<tr>
      <td><input value="${e.id||''}"></td>
      <td><input value="${e.razon||''}"></td>
      <td><input value="${e.ruc||''}"></td>
      <td><input value="${e.direccion||''}"></td>
      <td><input value="${e.telefono||''}"></td>
    </tr>`).join('')}</tbody></table></div>`;

  qs('#usr-table').innerHTML = `
  <div class="table-wrap"><table style="width:100%;border-collapse:collapse">
    <thead><tr style="background:#f8fafc"><th>Email</th><th>DNI</th><th>Nombres</th><th>Apellidos</th><th>Rol</th><th>Activo</th><th>Empresa</th><th>ProyDef</th><th>Proys (coma)</th></tr></thead>
    <tbody>${usr.map(u=>`<tr>
      <td><input value="${u.email||''}"></td>
      <td><input value="${u.dni||''}"></td>
      <td><input value="${u.nombres||''}"></td>
      <td><input value="${u.apellidos||''}"></td>
      <td><input value="${u.rol||''}"></td>
      <td><input value="${u.activo?'1':'0'}"></td>
      <td><input value="${u.empresaid||''}"></td>
      <td><input value="${u.proydef||''}"></td>
      <td><input value="${(u.proys||[]).join(', ')}"></td>
    </tr>`).join('')}</tbody></table></div>`;
}

// Guardar admin
qs('#emp-save').onclick = async ()=>{
  if(!adminOK) return;
  const rows = qsa('#emp-table tbody tr').map(tr=>{
    const [id,razon,ruc,dir,tel] = Array.from(tr.querySelectorAll('input')).map(i=>i.value.trim());
    return {id,razon,ruc,direccion:dir,telefono:tel};
  });
  await api('/api/admin/empresas',{method:'POST',body:JSON.stringify(rows)});
  alert('Empresas guardadas');
};
qs('#usr-save').onclick = async ()=>{
  if(!adminOK) return;
  const rows = qsa('#usr-table tbody tr').map(tr=>{
    const [email,dni,nombres,apellidos,rol,activo,empresaid,proydef,proys] = Array.from(tr.querySelectorAll('input')).map(i=>i.value.trim());
    return {email,dni,nombres,apellidos,rol,activo:activo==='1'||activo.toLowerCase()==='true',empresaid,proydef,proys:proys?proys.split(/\s*,\s*/):[]};
  });
  await api('/api/admin/usuarios',{method:'POST',body:JSON.stringify(rows)});
  alert('Usuarios guardados');
};

// Login
qs('#btn-login').onclick = ()=>showLogin(true);
qs('#btn-logout').onclick = ()=>{ localStorage.removeItem('planilla_email'); location.reload(); };
qs('#login-ok').onclick = async ()=>{
  const email = qs('#login-email').value.trim();
  if(!email) return;
  try{
    S.user = await api('/api/login?email='+encodeURIComponent(email));
    localStorage.setItem('planilla_email', S.user.email);
    showLogin(false); afterLogin();
  }catch(e){ alert(e.message||'No se pudo iniciar sesión'); }
};

function afterLogin(){
  setWho(); fillHeaderByEmpresa(); fillUsersSelect(); renderRows(); calcAcc();
  qs('#btn-login').style.display='none'; qs('#btn-logout').
