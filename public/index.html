<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planilla de Movilidad</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  :root{ --p:#2563eb; --p600:#1d4ed8; --ink:#0f172a; --mut:#64748b; --line:#e2e8f0; --bg:#f1f5f9; --card:#fff; --ok:#16a34a; --bad:#ef4444; }
  *{box-sizing:border-box} body{margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:var(--bg); color:var(--ink); padding:18px;}
  .app{max-width:1180px; margin:0 auto;}
  .top{display:flex; align-items:center; justify-content:space-between; margin-bottom:10px}
  .who{font-size:.9rem; color:var(--mut)} .btn{border:1px solid var(--line); background:var(--card); border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700}
  .btn.primary{background:var(--p); color:#fff; border-color:var(--p)} .btn.primary:hover{background:var(--p600)}
  .tabs{display:flex; gap:12px; margin:4px 0 12px} .tab{border:none; background:transparent; padding:10px 14px; font-weight:700; border-bottom:2px solid transparent; color:var(--mut); cursor:pointer}
  .tab.active{color:var(--p); border-bottom-color:var(--p)} .view{display:none} .view.active{display:block}
  .card{background:var(--card); border-radius:16px; box-shadow:0 10px 28px rgba(2,8,23,.06); overflow:hidden; margin-bottom:14px}
  .card-h,.card-b{padding:16px 18px} .card-h{border-bottom:1px solid var(--line); background:linear-gradient(180deg,#fff,#fbfdff)}
  .brand{display:flex; justify-content:space-between; align-items:flex-start; gap:12px}
  .brand .logo{height:42px; width:160px; background:#eee; border-radius:8px}
  .cinfo{font-size:.86rem; color:var(--mut); text-align:right}
  .title{margin:6px 0 0; text-align:center; font-size:1.25rem} .subtitle{text-align:center; margin:2px 0 0; font-size:.92rem; font-weight:800; color:#1d4ed8}
  .grid{display:grid; gap:12px; grid-template-columns:1fr 1fr}
  .group label{display:block; margin:0 0 6px; font-weight:700; font-size:.9rem}
  .group input,.group select{width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; background:#fff}
  .worker-row{display:flex; gap:8px; align-items:flex-end}
  .thead,.row{display:grid; grid-template-columns:34px 1.2fr 1.2fr 1fr .7fr .7fr 46px; gap:10px; align-items:center}
  .thead{padding:0 0 6px; color:var(--mut); text-transform:uppercase; font-size:.72rem}
  .row{padding:6px 10px; border-bottom:1px solid var(--line); background:#fff}
  .row:nth-child(odd){background:#fafafa}
  .row input,.row select{width:100%; padding:8px 10px; border:1px solid var(--line); border-radius:10px; background:#fff}
  .num{text-align:center; color:var(--mut); font-weight:800}
  .alert{margin:8px 18px 0; background:#fee2e2; color:#991b1b; border:1px solid #fecaca; padding:10px 12px; border-radius:12px; display:none}
  .totals{display:flex; gap:8px; justify-content:flex-end; align-items:center; background:#f8fafc; border-top:1px solid var(--line); padding:12px 18px}
  .pill{font-size:.78rem; padding:4px 8px; border-radius:999px; border:1px solid var(--line); color:var(--mut); background:#fff}
  .big{font-size:1.18rem; font-weight:900} .big.ok{color:var(--ok)} .big.bad{color:var(--bad)}
  .legal{padding:0 18px 16px; font-size:.76rem; color:#6b7280}

  .login-overlay{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; z-index:99}
  .login-card{background:#fff; border-radius:16px; padding:20px; width:min(420px,92%); box-shadow:0 12px 36px rgba(0,0,0,.28)}
  .login-card h3{margin:0 0 10px}

  .tbl{width:100%; border-collapse:collapse} .tbl th,.tbl td{border-bottom:1px solid var(--line); padding:6px 8px; text-align:left; font-size:.85rem}
  .tbl th{background:#f8fafc; text-transform:uppercase; font-size:.72rem}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div id="who" class="who">No autenticado</div>
    <div>
      <button id="btn-login" class="btn primary">Iniciar sesión</button>
      <button id="btn-logout" class="btn" style="display:none">Cerrar sesión</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="new">Nueva Planilla</button>
    <button class="tab" data-tab="hist">Historial</button>
    <button id="tab-admin" class="tab" data-tab="admin" style="display:none">Ajustes (Admin)</button>
  </div>

  <!-- NUEVA -->
  <div id="view-new" class="view active">
    <div class="card">
      <div class="card-h">
        <div class="brand">
          <div class="logo" id="logo"></div>
          <div class="cinfo" id="cinfo">
            <b id="emp-razon">—</b><br>
            R.U.C. <span id="emp-ruc">—</span><br>
            <span id="emp-dir"></span>
          </div>
        </div>
        <h2 class="title">PLANILLA DE MOVILIDAD</h2>
        <p class="subtitle">PROYECTO PRINCIPAL: <span id="proy-principal">—</span></p>
      </div>
      <div class="card-b">
        <div class="grid">
          <div class="group">
            <label>Fecha de Emisión</label>
            <input id="f-emision" type="date">
          </div>
          <div class="worker-row">
            <div class="group" style="flex:1">
              <label>Trabajador Seleccionado</label>
              <select id="sel-trabajador"></select>
            </div>
            <button id="btn-add-row" class="btn" title="Agregar fila">+</button>
          </div>
        </div>
      </div>

      <div class="card-b" style="padding-top:0">
        <div class="thead">
          <span>#</span><span>Destino</span><span>Motivo</span><span>Proyecto</span><span>PC</span><span>Monto (S/)</span><span></span>
        </div>
        <div id="rows"></div>
        <div id="alert" class="alert">Has superado el tope diario.</div>
      </div>

      <div class="totals">
        <span class="pill">Tope por día: <b id="pill-tope">S/ 45.00</b></span>
        <span class="pill">Acumulado día: <b id="pill-acc">S/ 0.00</b></span>
        <span class="pill">Disponible: <b id="pill-disp">S/ 45.00</b></span>
        <span style="margin-left:8px; font-weight:800">Total:</span>
        <span id="total" class="big ok">S/ 0.00</span>
      </div>

      <div class="legal">
        <b>Base Legal:</b> Inciso a1) del artículo 37° del TUO de la Ley del Impuesto a la Renta e inciso v) del artículo 21° del Reglamento de la ley del Impuesto a la Renta. La falta de consignación de la fecha en que se incurrió en el gasto, nombres y apellidos de cada trabajador, número de DNI, motivo y destino del desplazamiento y monto gastado, respecto a cada desplazamiento sólo inhabilita la planilla para la sustentación del gasto que corresponda a tal desplazamiento. (*) Numeración de la planilla.
      </div>
    </div>

    <button id="btn-save" class="btn primary">Finalizar, Guardar y Exportar a PDF</button>
  </div>

  <!-- HISTORIAL -->
  <div id="view-hist" class="view">
    <div class="card">
      <div class="card-h"><b>Historial</b></div>
      <div class="card-b">
        <table class="tbl" id="hist"></table>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="view-admin" class="view">
    <div class="card">
      <div class="card-h"><b>Validar PIN admin</b></div>
      <div class="card-b">
        <input id="pin" type="password" placeholder="1234" style="padding:10px; border:1px solid var(--line); border-radius:10px">
        <button id="btn-pin" class="btn primary">Ingresar</button>
        <span id="pin-ok" style="color:#059669; font-weight:700; margin-left:10px"></span>
      </div>
    </div>
    <div class="card">
      <div class="card-h"><b>Empresas (vista)</b></div>
      <div class="card-b"><div id="emp-admin"></div></div>
    </div>
    <div class="card">
      <div class="card-h"><b>Usuarios (vista)</b></div>
      <div class="card-b"><div id="usr-admin"></div></div>
    </div>
  </div>
</div>

<!-- LOGIN -->
<div id="login" class="login-overlay" style="display:flex">
  <div class="login-card">
    <h3>Iniciar sesión</h3>
    <div class="group"><label>Email</label><input id="login-email" type="email" placeholder="admin@empresa.com"></div>
    <div style="margin-top:10px; font-size:.85rem; color:var(--mut)">Se valida contra la tabla <b>usuarios</b>. No se pide contraseña.</div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px">
      <button id="btn-do-login" class="btn primary">Entrar</button>
    </div>
  </div>
</div>

<script>
// --------- Estado ----------
const STATE = { empresas:[], usuarios:[], pcs:[], tope:45, acumulado:0, total:0, items:[], email:'', user:null };
const qs = s=>document.querySelector(s);
const qsa = s=>Array.from(document.querySelectorAll(s));

function money(n){ return 'S/ '+Number(n||0).toFixed(2); }
function toNum(v){
  if (v==null) return 0;
  let s = String(v).trim().replace(/,/g,'.').replace(/[^0-9.\-]/g,'');
  const p = s.split('.');
  if (p.length>2){ const last=p.pop(); s=p.join('')+'.'+last; }
  const n = parseFloat(s); return Number.isFinite(n)?Number(n.toFixed(2)):0;
}

async function api(path,opt={}){
  const r = await fetch(path, { headers:{'Content-Type':'application/json'}, credentials:'same-origin', ...opt });
  let d=null; try{ d = await r.json(); }catch{}
  if(!r.ok) throw (d||{error:`HTTP ${r.status}`});
  return d;
}

// --------- UI básicas ----------
function show(el){ el && (el.style.display=''); }
function hide(el){ el && (el.style.display='none'); }

function setTabs(){
  qsa('.tab').forEach(b=>{
    b.onclick=()=>{
      qsa('.tab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      const t=b.dataset.tab;
      qsa('.view').forEach(v=>v.classList.remove('active'));
      qs('#view-'+t).classList.add('active');
      if(t==='hist') loadHistorial();
    };
  });
}

function setWho(){
  const u = STATE.user;
  const who = u ? `Conectado: ${u.nombres} ${u.apellidos} — ${STATE.email} — Rol: ${u.rol} — DNI: ${u.dni}` : 'No autenticado';
  qs('#who').textContent = who;
}

function renderEmpresaHeader(){
  const emp = STATE.empresas.find(e=>e.id===STATE.user?.empresaid);
  qs('#emp-razon').textContent = emp?.razon || '—';
  qs('#emp-ruc').textContent = emp?.ruc || '—';
  qs('#emp-dir').textContent = emp?.direccion || '';
  qs('#proy-principal').textContent = STATE.user?.proydef || '—';
}

function llenarTrabajadores(){
  const sel = qs('#sel-trabajador');
  sel.innerHTML = '';
  STATE.usuarios.filter(u=>u.activo).forEach(u=>{
    const op = document.createElement('option');
    op.value = u.email; op.textContent = `${u.nombres} ${u.apellidos}`;
    if (u.email.toLowerCase()===STATE.email) op.selected = true;
    sel.appendChild(op);
  });
  sel.onchange = async ()=>{
    STATE.email = sel.value;
    localStorage.setItem('planilla_email', STATE.email);
    STATE.user = await api('/api/login?email='+encodeURIComponent(STATE.email));
    renderEmpresaHeader();
    await loadPCs();
    recalc(); // para PCs y proydef
  };
}

async function loadPCs(){
  STATE.pcs = await api('/api/pcs?emp='+encodeURIComponent(STATE.user.empresaid));
  qsa('.row .pc').forEach(s=>{
    s.innerHTML = '';
    STATE.pcs.forEach(c=>{
      const op=document.createElement('option'); op.value=c; op.textContent=c;
      s.appendChild(op);
    });
  });
}

// --------- Filas ---------
function addRow(data={}){
  const rows = qs('#rows');
  const ix = rows.children.length+1;
  const div = document.createElement('div');
  div.className='row';
  div.innerHTML = `
    <div class="num">${ix}</div>
    <input class="destino" placeholder="DESTINO" value="${(data.destino||'')}">
    <input class="motivo"  placeholder="MOTIVO"  value="${(data.motivo||'')}">
    <input class="proyecto uppercase" placeholder="PROYECTO" value="${(data.proyecto||STATE.user?.proydef||'')}">
    <select class="pc">${STATE.pcs.map(c=>`<option ${data.pc===c?'selected':''}>${c}</option>`).join('')}</select>
    <input class="monto" placeholder="0.00" value="${data.monto||''}">
    <button class="btn" title="Eliminar">🗑</button>
  `;
  rows.appendChild(div);

  const monto = div.querySelector('.monto');
  const del   = div.querySelector('button');
  monto.oninput = recalc;
  del.onclick = ()=>{ rows.removeChild(div); renumber(); recalc(); };
}

function renumber(){
  qsa('#rows .row .num').forEach((n,i)=> n.textContent = (i+1));
}

function readItems(){
  const out=[];
  qsa('#rows .row').forEach(r=>{
    const it = {
      destino:  (r.querySelector('.destino')?.value||'').trim().toUpperCase(),
      motivo:   (r.querySelector('.motivo') ?.value||'').trim().toUpperCase(),
      proyecto: (r.querySelector('.proyecto')?.value||'').trim().toUpperCase(),
      pc:       (r.querySelector('.pc')      ?.value||'').trim(),
      monto:    toNum(r.querySelector('.monto')?.value)
    };
    if (it.monto>0) out.push(it);
  });
  STATE.items = out;
  return out;
}

// --------- Reglas / Tope ---------
async function recalc(){
  const items = readItems();
  const total = Number(items.reduce((a,b)=>a + Number(b.monto||0),0).toFixed(2));
  STATE.total = total;

  const f = qs('#f-emision').value || '';
  let acc = 0;
  if (STATE.user?.dni && f){
    try{ const r = await api(`/api/acumulado?dni=${encodeURIComponent(STATE.user.dni)}&fecha=${encodeURIComponent(f)}`); acc = Number(r.acumulado||0); }
    catch(_){ acc=0; }
  }
  STATE.acumulado = acc;

  const disp = Math.max(0, STATE.tope - acc);
  qs('#pill-acc').textContent  = money(acc);
  qs('#pill-disp').textContent = money(disp);
  qs('#total').textContent     = money(total);
  qs('#total').classList.toggle('bad', total>disp+0.0001);
  qs('#total').classList.toggle('ok',  total<=disp+0.0001);

  const over = (acc + total) > STATE.tope + 0.0001;
  const al = qs('#alert');
  if (over) { al.style.display='block'; al.textContent = `Has superado el tope disponible de ${money(disp)}.`; }
  else { al.style.display='none'; } // <- corrige que no se ocultaba
}

// --------- Guardar & PDF ---------
async function guardar(){
  if (!STATE.user) return alert('Inicia sesión');
  const f = qs('#f-emision').value;
  if (!f) return alert('Selecciona la fecha');

  const items = readItems();
  if (!items.length) return alert('Ingresa al menos un ítem con monto.');

  const btn = qs('#btn-save'); btn.disabled = true;
  try{
    const r = await api('/api/planillas', {
      method:'POST',
      body: JSON.stringify({ dni: STATE.user.dni, email: STATE.email, fecha: f, items })
    });

    await renderPDF({
      fecha: r.fecha || f,
      items,
      total: r.total,
      serie: r.serie,
      num:   r.num,
      emp:   r.empresa,
      u:     STATE.user
    });

    alert(`Planilla ${r.serie}-${r.num} guardada y exportada.`);
    loadHistorial();

  }catch(e){
    alert(e?.error || 'Error al guardar.');
    console.error(e);
  }finally{ btn.disabled = false; }
}

async function renderPDF({ fecha, items, total, serie, num, emp, u }){
  const jsPDFCtor = (window.jspdf&&window.jspdf.jsPDF)||window.jsPDF;
  const doc = new jsPDFCtor({ unit:'pt', format:'a4' });

  doc.setFontSize(12);
  doc.text(emp?.razon||'—', 40,40);
  doc.text(`R.U.C.: ${emp?.ruc||'—'}`, 40,58);
  doc.setFontSize(14);
  doc.text('PLANILLA DE MOVILIDAD', 300,40,{align:'center'});
  doc.text(`Planilla Nro. ${serie}-${num}`, 300,58,{align:'center'});
  doc.setFontSize(10);
  doc.text(`Fecha de Emisión: ${fecha}`, 40,90);
  doc.text(`Trabajador: ${(u?.nombres||'').toUpperCase()} ${(u?.apellidos||'').toUpperCase()}  DNI: ${u?.dni||''}`, 40,108);

  let y=140; const cols=['#','DESTINO','MOTIVO','PROYECTO','PC','MONTO (S/)']; const w=[24,120,120,160,60,80];
  const row=(c,yy,h=false)=>{ let x=40; for(let i=0;i<c.length;i++){ doc.rect(x,yy,w[i],22); doc.setFontSize(h?10:9); doc.text(String(c[i]??''),x+3,yy+14); x+=w[i]; } };
  row(cols,y,true); y+=22;
  items.forEach((it,ix)=>{ if(y>760){ doc.addPage(); y=40; }
    row([ix+1,(it.destino||''),(it.motivo||''),(it.proyecto||''),(it.pc||''), Number(it.monto||0).toFixed(2)],y); y+=22;
  });
  y+=10; doc.setFontSize(12); doc.text(`Total: ${money(total)}`, 40, y+20);
  doc.save(`${serie}-${num}.pdf`);
}

// --------- Historial ---------
async function loadHistorial(){
  const isAdmin = STATE.user?.rol?.startsWith('ADMIN');
  const url = isAdmin ? '/api/historial?all=1' : '/api/historial?email='+encodeURIComponent(STATE.email);
  const rows = await api(url);
  const tbl = qs('#hist');
  tbl.innerHTML = `
   <tr><th>Fecha</th><th>Serie</th><th>Número</th><th>DNI</th><th>Email</th><th>Empresa</th><th>Total</th></tr>
   ${rows.map(r=>`<tr>
     <td>${r.fecha}</td><td>${r.serie}</td><td>${String(r.num).padStart(5,'0')}</td>
     <td>${r.dni}</td><td>${r.email}</td><td>${r.empresaid}</td><td>${money(r.total)}</td>
   </tr>`).join('')}
  `;
}

// --------- Login ----------
async function doLogin(email){
  const u = await api('/api/login?email='+encodeURIComponent(email));
  if (!u?.activo) throw new Error('Usuario inactivo');

  STATE.email = u.email;
  STATE.user = u;
  localStorage.setItem('planilla_email', u.email);

  setWho();
  hide(qs('#login'));
  show(qs('#btn-logout')); hide(qs('#btn-login'));
  qs('#tab-admin').style.display = u.rol?.startsWith('ADMIN') ? '' : 'none';

  renderEmpresaHeader();
  llenarTrabajadores();
  await loadPCs();
  recalc();
}

// --------- Inicio ----------
window.addEventListener('DOMContentLoaded', async ()=>{
  setTabs();

  // Config/Tope
  try{ const v = await api('/api/version'); STATE.tope = Number(v.tope||45); }catch(_){}
  qs('#pill-tope').textContent = money(STATE.tope);

  // base
  STATE.empresas = await api('/api/empresas?simple=1');
  STATE.usuarios = await api('/api/usuarios');

  // fecha default hoy
  const td = new Date(); qs('#f-emision').value = td.toISOString().slice(0,10);
  qs('#f-emision').onchange = recalc;

  // 5 filas por defecto
  for(let i=0;i<5;i++) addRow();
  qs('#btn-add-row').onclick = ()=> addRow();

  // eventos
  qs('#btn-save').onclick = guardar;
  qs('#btn-do-login').onclick = async ()=>{
    const em = (qs('#login-email').value||'').trim();
    if(!em) return alert('Ingresa el email');
    try{ await doLogin(em); }catch(e){ alert(e?.error||e?.message||'Login error'); }
  };
  qs('#btn-login').onclick = ()=> show(qs('#login'));
  qs('#btn-logout').onclick = ()=>{ localStorage.removeItem('planilla_email'); location.reload(); };

  // auto-login con localStorage
  let em = localStorage.getItem('planilla_email')||'';
  if (!em) show(qs('#login')); else { try{ await doLogin(em); }catch(_){ show(qs('#login')); }}

  // admin: validar pin (solo para habilitar acciones de update si las agregas)
  qs('#btn-pin').onclick = async ()=>{
    try{
      const r = await api('/api/admin/pin',{ method:'POST', body: JSON.stringify({pin:qs('#pin').value})});
      qs('#pin-ok').textContent = r.ok ? 'OK' : '';
      if (!r.ok) alert('PIN inválido');
    }catch(e){ alert('PIN inválido'); }
  };
});
</script>
</body>
</html>
