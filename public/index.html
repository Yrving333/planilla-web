<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Planilla de Movilidad ‚Äî S/45 (Login + Roles)</title>

<!-- Libs -->
<script src="https://alcdn.msauth.net/browser/2.38.2/js/msal-browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<!-- evitar cach√© agresiva en deploy -->
<meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<style>
  /* ‚Ä¶ (MISMO CSS QUE TEN√çAS; sin cambios de estilos) ‚Ä¶ */
  /* Para ahorrar espacio aqu√≠, mantengo exactamente tu CSS previo. */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
  :root{
    --primary:#2563eb;--primary-600:#1d4ed8;
    --ink:#0f172a;--muted:#64748b;--line:#e2e8f0;
    --bg:#f1f5f9;--card:#ffffff;--chip:#f8fafc;
    --ok:#16a34a;--bad:#ef4444;--zebra:#fafafa
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink);padding:20px;display:flex;justify-content:center}
  .app{width:100%;max-width:1180px}
  .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px}
  .who{font-size:.92rem;color:var(--muted)}
  .btn{border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;letter-spacing:.2px}
  .btn.primary{background:var(--primary);color:#fff;box-shadow:0 6px 20px rgba(37,99,235,.18)}
  .btn.primary:hover{background:var(--primary-600)}
  .btn.ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}
  .btn.small{padding:6px 10px;font-size:.85rem}
  .btn.danger{background:#ef4444;color:#fff;border:0}
  .tabs{display:flex;gap:12px;margin-bottom:16px}
  .tab{padding:10px 16px;border:none;background:transparent;border-bottom:2px solid transparent;color:var(--muted);cursor:pointer;font-weight:700}
  .tab.active{color:var(--primary);border-bottom-color:var(--primary)}
  .view{display:none}.view.active{display:block}

  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 28px rgba(2,8,23,.06);margin-bottom:16px;overflow:hidden}
  .card-h,.card-b{padding:18px 20px}.card-h{border-bottom:1px solid var(--line);background:linear-gradient(180deg,#ffffff, #fbfdff)}
  .brand{display:flex;justify-content:space-between;gap:16px;align-items:flex-start}
  .brand img{max-height:42px}
  .cinfo{font-size:.86rem;color:var(--muted);text-align:right;line-height:1.45}
  .cinfo b{color:var(--ink)}
  h1.title{margin:8px 0 2px;text-align:center;font-size:1.28rem;letter-spacing:.2px}
  .subtitle{margin:0;text-align:center;color:#1d4ed8;font-weight:800;font-size:.92rem}

  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .group label{display:block;margin:0 0 6px;font-weight:700;font-size:.9rem}
  .group input,.group select,.group textarea{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:.95rem;background:#fff}
  .uppercase{text-transform:uppercase}
  .worker-row{display:flex;gap:8px;align-items:flex-end}

  .list{padding:0 20px 10px}
  .thead,.trow{display:grid;grid-template-columns:34px 1.2fr 1.2fr 1fr .7fr .7fr 64px;gap:10px;align-items:center}
  .thead{padding:0 0 6px;color:var(--muted);text-transform:uppercase;font-size:.72rem}
  .trow{padding:6px 10px;border-bottom:1px solid var(--line);background:#fff}
  .trow:nth-child(odd){background:var(--zebra)}
  .trow input,.trow select{width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:#fff}
  .num{color:var(--muted);text-align:center;font-weight:900}
  .row-actions{display:flex;gap:6px;justify-content:flex-end}

  .alert{width:calc(100% - 40px);background:#fee2e2;color:#991b1b;border:1px solid #fecaca;border-radius:12px;padding:10px 12px;margin:6px 20px 0;display:none}
  .total{display:flex;flex-wrap:wrap;gap:10px;justify-content:flex-end;align-items:center;background:var(--chip);border-top:1px solid var(--line);padding:14px 20px}
  .pill{font-size:.78rem;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);background:white}
  .amount{font-size:1.22rem;font-weight:900}
  .amount.ok{color:var(--ok)} .amount.bad{color:var(--bad)}
  .legal{font-size:.75rem;color:#6b7280;text-align:justify;padding:0 20px 18px}

  .table-wrap{overflow-x:auto}
  table.tbl{width:100%;border-collapse:collapse;table-layout:fixed}
  .tbl th,.tbl td{border-bottom:1px solid var(--line);padding:5px 6px;text-align:left;font-size:.76rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .tbl th{background:#f8fafc;text-transform:uppercase;font-size:.7rem}
  .center{text-align:center}
  .w-s{width:78px;min-width:78px}
  .w-m{width:108px;min-width:108px}
  .w-l{width:160px;min-width:160px}

  .login-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;justify-content:center;z-index:9999}
  .login-card{background:#fff;border-radius:16px;box-shadow:0 12px 36px rgba(0,0,0,.25);padding:22px 20px;min-width:340px;max-width:420px}
  .login-card h3{margin:0 0 6px}
  .hint{font-size:.82rem;color:var(--muted);margin-top:4px}
  .login-actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end;flex-wrap:wrap}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="who" id="who">No autenticado</div>
    <div>
      <button id="btn-login" class="btn primary" onclick="login()">Iniciar sesi√≥n</button>
      <button id="btn-logout" class="btn ghost" onclick="logout()" style="display:none">Cerrar sesi√≥n</button>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="show('new')">Nueva Planilla</button>
    <button class="tab" onclick="show('hist')">Historial</button>
    <button id="tab-admin" class="tab" onclick="show('admin')" style="display:none">Ajustes (Admin)</button>
  </div>

  <!-- NUEVA -->
  <div id="view-new" class="view active">
    <div class="card">
      <div class="card-h">
        <div class="brand">
          <img id="logo" alt="Logo empresa" style="display:none">
          <div id="cinfo" class="cinfo"><b>‚Äî</b><br>R.U.C. ‚Äî<br><span id="caddr"></span></div>
        </div>
        <h1 id="h-num" class="title">PLANILLA DE MOVILIDAD ‚Äî Nro. (por asignar)</h1>
        <p id="p-proy" class="subtitle">PROYECTO PRINCIPAL: ‚Äî</p>
      </div>
      <div class="card-b">
        <div class="grid">
          <div class="group">
            <label for="f-emision">Fecha de Emisi√≥n</label>
            <input id="f-emision" type="date" onchange="onFechaChange()">
          </div>
          <div class="worker-row">
            <div class="group" style="flex:1">
              <label for="sel-trabajador">Trabajador Seleccionado</label>
              <select id="sel-trabajador" onchange="onTrabajadorChange()"></select>
            </div>
            <button id="btn-new-worker" class="btn ghost small" onclick="openTrabajadorEditor(false)" title="Nuevo trabajador">+</button>
            <button id="btn-edit-worker" class="btn ghost small" onclick="openTrabajadorEditor(true)" title="Editar trabajador">‚úé</button>
          </div>
        </div>
      </div>

      <div class="list">
        <div style="display:flex;justify-content:space-between;align-items:center;margin:0 20px 8px">
          <div class="thead" style="flex:1">
            <span>#</span><span>Destino</span><span>Motivo</span><span>Proyecto</span><span>PC</span><span>Monto (S/)</span><span></span>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn ghost small" onclick="addRow()">+ Fila</button>
          </div>
        </div>
        <div id="rows"></div>
      </div>

      <div id="over-alert" class="alert">Has superado el tope de <b>S/ 45</b> por d√≠a/usuario. Ajusta los montos o cambia la fecha.</div>

      <div class="total">
        <span class="pill">Tope por d√≠a: <b>S/ 45.00</b></span>
        <span class="pill">Acumulado d√≠a: <b id="pill-acum">S/ 0.00</b></span>
        <span class="pill">Disponible: <b id="pill-disp">S/ 45.00</b></span>
        <span style="font-weight:800">Total:</span>
        <span id="total" class="amount ok">S/ 0.00</span>
      </div>

      <div class="legal">
        <b>Base Legal:</b> Inciso a1) del art√≠culo 37¬∞ del TUO de la Ley del Impuesto a la Renta e inciso v) del articulo 21¬∞ del Reglamento de la ley del Impuesto a la Renta‚Ä¶
      </div>
    </div>
    <button id="btn-save" class="btn primary" onclick="guardarPlanilla()">Finalizar, Guardar y Exportar a PDF</button>
  </div>

  <!-- HISTORIAL -->
  <div id="view-hist" class="view">
    <div class="card">
      <div class="card-h" style="display:flex;justify-content:space-between;align-items:center">
        <b>Historial de Planillas</b>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn ghost small" onclick="refreshFromServer()" title="Sincronizar">‚Üª Sincronizar</button>
          <div id="hist-admin-actions" style="display:none;gap:8px">
            <button class="btn ghost" onclick="toggleHistEdit()">Editar historial</button>
            <button id="hist-save" class="btn primary" onclick="saveHistEdits()" style="display:none">Guardar cambios</button>
            <button id="hist-del" class="btn danger" onclick="deleteHistRows()" style="display:none">Eliminar seleccionados</button>
          </div>
        </div>
      </div>
      <div class="card-b"><div class="table-wrap"><div id="hist"></div></div></div>
    </div>
  </div>

  <!-- AJUSTES (ADMIN) -->
  <div id="view-admin" class="view">
    <div class="card">
      <div class="card-h"><b>Acceso administrador</b></div>
      <div class="card-b" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="pin-in" type="password" placeholder="PIN admin (por defecto: 1234)" style="max-width:220px">
        <button class="btn primary" onclick="loginAdmin()">Ingresar</button>
        <span id="pin-ok" style="color:#059669;font-weight:700"></span>
      </div>
    </div>

    <div class="card">
      <div class="card-h"><b>Empresas</b></div>
      <div class="card-b">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="emp-add" class="btn ghost" onclick="empAdd()" disabled>Agregar empresa</button>
          <button id="emp-save" class="btn primary" onclick="empSaveAll()" disabled>Guardar cambios</button>
        </div>
        <div class="table-wrap"><div id="emp-table"></div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-h"><b>Usuarios</b></div>
      <div class="card-b">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button id="usr-add" class="btn ghost" onclick="usrAdd()" disabled>Agregar usuario</button>
          <button id="usr-save" class="btn primary" onclick="usrSaveAll()" disabled>Guardar cambios</button>
        </div>
        <div class="table-wrap"><div id="usr-table"></div></div>
      </div>
    </div>
  </div>

  <!-- MODAL Trabajador (UI sin cambios, s√≥lo usado por admin) -->
  <div id="modal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1000">
    <div style="background:#fff;border-radius:16px;padding:18px;min-width:340px;max-width:560px">
      <h3 id="m-title" style="margin:0 0 10px">Trabajador</h3>
      <div class="grid">
        <div class="group"><label>Nombres</label><input id="m-nombres" class="uppercase"></div>
        <div class="group"><label>Apellidos</label><input id="m-apellidos" class="uppercase"></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div class="group"><label>DNI</label><input id="m-dni" maxlength="8"></div>
        <div class="group"><label>Empresa</label><select id="m-empresa"></select></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div class="group"><label>Rol</label>
          <select id="m-rol">
            <option value="ADMIN_PADOVA">ADMIN_PADOVA</option>
            <option value="USUARIO">USUARIO</option>
          </select>
        </div>
        <div class="group"><label>Proyecto por defecto</label><input id="m-proydef" class="uppercase"></div>
      </div>
      <div class="group" style="margin-top:8px">
        <label>Proyectos permitidos (coma)</label>
        <textarea id="m-proys" rows="2" class="uppercase" placeholder="ADMIN PADOVA, LITORAL 900, SANTA BEATRIZ"></textarea>
      </div>
      <div class="group" style="margin-top:8px">
        <label>Email (para login)</label>
        <input id="m-email" type="email" placeholder="usuario@tuempresa.com"/>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn ghost" onclick="closeModal()">Cancelar</button>
        <button class="btn primary" onclick="saveModal()">Guardar</button>
      </div>
    </div>
  </div>

  <!-- LOGIN OVERLAY -->
  <div id="login-overlay" class="login-overlay" style="display:none">
    <div class="login-card">
      <h3>Iniciar sesi√≥n</h3>

      <!-- Modo API -->
      <div id="login-api" style="display:none">
        <div class="group"><label>Email</label><input id="api-email" type="email" placeholder="admin@empresa.com"></div>
        <div class="group" style="margin-top:8px"><label>Contrase√±a</label><input id="api-pass" type="password" placeholder="******"></div>
        <div class="login-actions">
          <button class="btn primary" onclick="apiLogin()">Entrar</button>
        </div>
      </div>

      <!-- Modo local (demo) -->
      <div id="login-local" style="display:none">
        <div class="group"><label>Email</label><input id="local-email" type="email" placeholder="admin@empresa.com"></div>
        <div class="group" style="margin-top:8px"><label>Clave</label><input id="local-pass" type="password" placeholder="******"></div>
        <div class="hint">Modo DEMO: se valida contra la tabla <b>Usuarios</b>. La clave no se valida.</div>
        <div class="login-actions">
          <button class="btn danger" onclick="resetDemo()">Restablecer demo</button>
          <button class="btn primary" onclick="localLogin()">Entrar</button>
        </div>
      </div>

      <!-- Modo MSAL/SharePoint -->
      <div id="login-msal" style="display:none">
        <div class="hint">Autent√≠cate con tu cuenta de Microsoft 365.</div>
        <div class="login-actions"><button class="btn primary" onclick="msalLogin()">Entrar con Microsoft</button></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ===================== CONFIG ===================== */
const MODE = 'api';
const API_BASE = '';
const TOPE = 45.00;
const PC_CODES = ['94303','95301','95303','234120502','234120503'];
const ADMIN_PIN_DEFAULT = '1234';

window.jsPDF = window.jspdf.jsPDF;

/* ======= Estado ======= */
let ADMIN_OK=false, HIST_EDIT=false, LAST_EXCEDE=false;
let SESSION={email:null,display:null,dni:null,rol:null,id:null,proy_def:null};
let EMPRESA_CACHE=null; // Empresa del usuario logueado
let EMPRESAS_STATE=[];  // Para ajustes (admin)
let USUARIOS_STATE=[];  // Para ajustes (admin)

/* ======= Helpers ======= */
const fmt=n=>'S/ '+Number(n||0).toFixed(2);
const normalizar=t=>(t||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const authHeader=()=>{const t=localStorage.getItem('mv_apiToken')||'';return t?{'Authorization':'Bearer '+t}:{}}; 
const getJSON = async (url, opts={}) => {
  const res = await fetch(url,{...opts,headers:{'Content-Type':'application/json',...(opts.headers||{}),...authHeader()}});
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return res.json();
};

/* ======= Inicio ======= */
document.addEventListener('DOMContentLoaded', ()=>{
  showLoginOverlay(true);
});

/* ======= Login ======= */
function showLoginOverlay(show){
  const ov=document.getElementById('login-overlay');
  ov.style.display=show?'flex':'none';
  document.getElementById('login-api').style.display = (MODE==='api') ? 'block' : 'none';
  document.getElementById('login-local').style.display = (MODE==='local') ? 'block' : 'none';
  document.getElementById('login-msal').style.display = (MODE==='sharepoint') ? 'block' : 'none';
  document.getElementById('btn-login').style.display = show?'none':'inline-block';
  document.getElementById('btn-logout').style.display= show?'none':'inline-block';
}
function login(){ showLoginOverlay(true); }
function logout(){
  ADMIN_OK=false; HIST_EDIT=false;
  SESSION={email:null,display:null,dni:null,rol:null,id:null,proy_def:null};
  EMPRESA_CACHE=null;
  document.getElementById('who').textContent='No autenticado';
  document.getElementById('tab-admin').style.display='none';
  document.getElementById('hist-save').style.display='none';
  document.getElementById('hist-del').style.display='none';
  document.getElementById('hist-admin-actions').style.display='none';
  showLoginOverlay(true);
}

async function apiLogin(){
  try{
    const email=(document.getElementById('api-email').value||'').trim().toLowerCase();
    const password=(document.getElementById('api-pass').value||'').trim(); // DEMO_LOGIN ignora pass en backend
    if(!email||!password){ alert('Ingresa email y contrase√±a'); return; }

    const res=await fetch(`${API_BASE}/api/login`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password})
    });
    if(!res.ok){
      const msg=await res.text().catch(()=>res.statusText);
      throw new Error(`HTTP ${res.status}: ${msg}`);
    }
    const data=await res.json();
    localStorage.setItem('mv_apiToken', data.token||'');

    const u=data.usuario||{};
    SESSION={
      email:(u.email||'').toLowerCase(),
      display:`${u.nombres||''} ${u.apellidos||''}`.trim(),
      dni:u.dni||null,
      rol:u.rol||'USUARIO',
      id:u.id||null,
      proy_def:(u.proy_def||'').toUpperCase()
    };
    EMPRESA_CACHE = u.empresa || null; // {id, razon, ruc, direccion, telefono, logo}

    document.getElementById('who').textContent=`Conectado: ${SESSION.display} ‚Äî ${SESSION.email} ‚Äî Rol: ${SESSION.rol}`;
    applySessionUI(); initMainUI(); showLoginOverlay(false);

    await refreshFromServer(true); // primer sync historial
  }catch(err){
    console.error('apiLogin error', err);
    alert('Error al iniciar sesi√≥n: '+err.message);
  }
}

/* ======= Navegaci√≥n de vistas ======= */
function show(id){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('view-'+id).classList.add('active');
  document.querySelector(`.tab[onclick="show('${id}')"]`).classList.add('active');
  if(id==='hist'){ refreshFromServer().finally(()=>renderHistorial()); }
  if(id==='admin'){ renderEmpresasTable(); renderUsuariosTable(); }
}

/* ======= UI y datos ======= */
function isAdmin(){ return SESSION.rol==='ADMIN_PADOVA'; }
function applySessionUI(){
  const isA=isAdmin();
  document.getElementById('tab-admin').style.display=isA?'inline-block':'none';
  document.getElementById('btn-new-worker').style.display=isA?'inline-block':'none';
  document.getElementById('btn-edit-worker').style.display=isA?'inline-block':'none';
  document.getElementById('hist-admin-actions').style.display=isA?'flex':'none';
  if(!isA){ HIST_EDIT=false; }
  document.getElementById('hist-save').style.display=(isA && HIST_EDIT)?'inline-block':'none';
  document.getElementById('hist-del').style.display=(isA && HIST_EDIT)?'inline-block':'none';
}
async function initMainUI(){
  document.getElementById('f-emision').value=new Date().toISOString().split('T')[0];
  await renderTrabajadoresSelect();
  onTrabajadorChange();
  renderRows(true);
  renderHistorial();
}
function setHeaderEmpresa(emp){
  const logo=document.getElementById('logo'), cinfo=document.getElementById('cinfo');
  if(emp){ 
    if(emp.logo){logo.src=emp.logo;logo.style.display='block';} else logo.style.display='none';
    cinfo.innerHTML=`<b>${emp.razon||'‚Äî'}</b><br>R.U.C. ${emp.ruc||'‚Äî'}<br><span id="caddr">${emp.direccion||''}</span>`;
  }else{
    logo.style.display='none';
    cinfo.innerHTML=`<b>‚Äî</b><br>R.U.C. ‚Äî<br><span id="caddr"></span>`;
  }
}

async function renderTrabajadoresSelect(){
  const sel=document.getElementById('sel-trabajador');
  sel.innerHTML='';
  const all = await getJSON(`${API_BASE}/api/usuarios`);
  const list = isAdmin() ? all : all.filter(u => (u.email||'').toLowerCase()===SESSION.email);
  USUARIOS_STATE = list.slice(); // cache para admin modal
  list.forEach(u=>{const o=document.createElement('option');o.value=u.dni;o.textContent=`${u.nombres} ${u.apellidos}`;sel.appendChild(o);});
  if(list.length>0) sel.value=list[0].dni;
}

function currentUserFromState(){
  const dni=document.getElementById('sel-trabajador').value;
  return USUARIOS_STATE.find(u=>String(u.dni)===String(dni))||null;
}

function onTrabajadorChange(){
  const u=currentUserFromState();
  const proy=document.getElementById('p-proy');
  document.getElementById('h-num').textContent='PLANILLA DE MOVILIDAD ‚Äî Nro. (por asignar)';
  if(u){
    proy.textContent=`PROYECTO PRINCIPAL: ${(u.proy_def||'').toUpperCase()}`;
    // header empresa (de cache en login o buscar en lista empresas)
    if(EMPRESA_CACHE && EMPRESA_CACHE.id===u.empresa_id){
      setHeaderEmpresa(EMPRESA_CACHE);
    }else{
      setHeaderEmpresa(EMPRESA_CACHE); // suficiente para header
    }
  }else{
    proy.textContent='PROYECTO PRINCIPAL: ‚Äî';
    setHeaderEmpresa(null);
  }
  refreshProyectoControls();
  updateTotalsUI(); // async calcula acumulado en server
}

/* ======= Filas din√°micas ======= */
function makeRow(idx){
  const r=document.createElement('div'); r.className='trow';
  r.innerHTML=`
    <span class="num">${idx}</span>
    <input class="destino uppercase" placeholder="DESTINO">
    <input class="motivo uppercase" placeholder="MOTIVO">
    <div class="proy-cell"></div>
    <select class="pc">${PC_CODES.map(c=>`<option value="${c}">${c}</option>`).join('')}</select>
    <input type="number" class="monto" min="0" step="0.01" placeholder="0.00" oninput="onMontoChange()">
    <div class="row-actions">
      <button class="btn ghost small" onclick="removeRow(this)" title="Eliminar fila">üóë</button>
    </div>
  `;
  return r;
}
function renderRows(initial=false){
  const rows=document.getElementById('rows'); rows.innerHTML='';
  const count = initial ? 5 : 1;
  for(let i=1;i<=count;i++) rows.appendChild(makeRow(i));
  refreshProyectoControls();
}
function addRow(){
  const rows=document.getElementById('rows');
  const idx=rows.children.length+1;
  rows.appendChild(makeRow(idx));
  refreshProyectoControls();
}
function renumberRows(){
  Array.from(document.querySelectorAll('#rows .trow .num')).forEach((el,i)=>el.textContent=String(i+1));
}
function removeRow(btn){
  const r=btn.closest('.trow'); if(!r) return;
  r.remove(); renumberRows(); updateTotalsUI();
}
function refreshProyectoControls(){
  const u=currentUserFromState();
  const canChoose = Boolean(u) && isAdmin();
  const list = (u?.proyectos||[]);
  document.querySelectorAll('.proy-cell').forEach(cell=>{
    cell.innerHTML='';
    if(canChoose){
      const sel=document.createElement('select'); sel.className='proyecto uppercase';
      list.forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;sel.appendChild(o);});
      cell.appendChild(sel);
    }else{
      const inp=document.createElement('input'); inp.className='proyecto uppercase'; inp.readOnly=true; inp.value=(u?.proy_def||'');
      cell.appendChild(inp);
    }
  });
}
function onMontoChange(){ updateTotalsUI(true); }
function currentTotal(){ return Array.from(document.querySelectorAll('.monto')).reduce((s,el)=>s+(parseFloat(el.value)||0),0); }

/* ======= Tope y disponible (consulta al servidor) ======= */
let _acumReq=0;
async function updateTotalsUI(alerta=false){
  const u=currentUserFromState();
  const fecha=document.getElementById('f-emision').value;
  const total=currentTotal();

  let acum=0;
  if(u && fecha){
    const myReq=++_acumReq;
    try{
      const data = await getJSON(`${API_BASE}/api/acumulado?dni=${encodeURIComponent(u.dni)}&fecha=${encodeURIComponent(fecha)}`);
      if(myReq!==_acumReq) return; // √∫ltima gana
      acum = Number(data.acumulado||0);
    }catch(_){}
  }

  const disp=Math.max(0,TOPE-acum-total);
  document.getElementById('pill-acum').textContent=fmt(acum);
  document.getElementById('pill-disp').textContent=fmt(disp);
  const exceed=(acum+total)>TOPE;
  const totalEl=document.getElementById('total'); totalEl.textContent=fmt(total);
  totalEl.classList.toggle('ok',!exceed); totalEl.classList.toggle('bad',exceed);
  document.getElementById('btn-save').disabled=exceed||!u;
  document.getElementById('over-alert').style.display=exceed?'block':'none';
  if(alerta && exceed && !LAST_EXCEDE){ alert('No puedes superar S/ 45 por d√≠a/usuario (incluye lo ya registrado).'); }
  LAST_EXCEDE=exceed;
}
function onFechaChange(){ updateTotalsUI(); }

/* ======= Historial (se llena desde /api/planillas) ======= */
function renderHistorial(){
  if(!isAdmin() || !ADMIN_OK){ HIST_EDIT=false; }
  const adminBar=document.getElementById('hist-admin-actions');
  adminBar.style.display=isAdmin()?'flex':'none';
  document.getElementById('hist-save').style.display=(isAdmin() && HIST_EDIT)?'inline-block':'none';
  document.getElementById('hist-del').style.display=(isAdmin() && HIST_EDIT)?'inline-block':'none';

  const hist=window.__HIST__||[];
  const wrap=document.getElementById('hist');
  if(hist.length===0){ wrap.innerHTML='<p style="color:#6b7280">No hay registros guardados.</p>'; return; }

  if(!HIST_EDIT){
    let html=`<table class="tbl"><thead><tr>
      <th class="w-s">#</th><th class="w-m">Serie</th><th class="w-m">N√∫mero</th><th class="w-m">Fecha</th>
      <th class="w-l">Trabajador</th><th class="w-l">Proyecto</th><th class="w-l">Destino</th><th class="w-l">Motivo</th>
      <th class="w-m">PC</th><th class="w-m">Monto</th><th class="w-m">Total</th>
    </tr></thead><tbody>`;
    hist.slice().forEach((r,i)=>{
      html+=`<tr>
        <td class="center">${i+1}</td><td>${r.serie}</td><td>${r.num}</td><td>${r.fecha}</td>
        <td>${r.trabajador}</td><td>${r.proyecto}</td><td>${r.destino}</td><td>${r.motivo}</td>
        <td>${r.pc}</td><td>${fmt(r.monto)}</td><td>${fmt(r.total)}</td>
      </tr>`;
    });
    html+='</tbody></table>'; wrap.innerHTML=html;
  }else{
    // Edici√≥n visual local (no implementamos guardado masivo del historial en server para mantener integridad)
    let html=`<table class="tbl"><thead><tr>
      <th class="center w-s">Sel</th><th class="w-s">#</th><th class="w-m">Serie</th><th class="w-m">N√∫mero</th><th class="w-m">Fecha</th>
      <th class="w-l">Trabajador</th><th class="w-l">Proyecto</th><th class="w-l">Destino</th><th class="w-l">Motivo</th>
      <th class="w-m">PC</th><th class="w-m">Monto</th><th class="w-m">Total</th>
    </tr></thead><tbody>`;
    hist.slice().forEach((r,i)=>{
      html+=`<tr data-ridx="${i}">
        <td class="center"><input type="checkbox" class="rowchk"></td>
        <td class="center">${i+1}</td>
        <td><input value="${r.serie}" class="uppercase w-m"></td>
        <td><input value="${r.num}" class="w-m"></td>
        <td><input value="${r.fecha}" class="w-m"></td>
        <td><input value="${r.trabajador}" class="uppercase w-l"></td>
        <td><input value="${r.proyecto}" class="uppercase w-l"></td>
        <td><input value="${r.destino}" class="uppercase w-l"></td>
        <td><input value="${r.motivo}" class="uppercase w-l"></td>
        <td><select class="w-m">${PC_CODES.map(c=>`<option value="${c}" ${c===r.pc?'selected':''}>${c}</option>`).join('')}</select></td>
        <td><input value="${Number(r.monto).toFixed(2)}" class="w-m"></td>
        <td><input value="${Number(r.total).toFixed(2)}" class="w-m"></td>
      </tr>`;
    });
    html+='</tbody></table>'; wrap.innerHTML=html;
  }
}
function toggleHistEdit(){
  if(!isAdmin()){ alert('Solo administradores pueden editar el historial.'); return; }
  if(!ADMIN_OK){ alert('Se requiere PIN de administrador.'); return; }
  HIST_EDIT=!HIST_EDIT;
  document.getElementById('hist-save').style.display=HIST_EDIT?'inline-block':'none';
  document.getElementById('hist-del').style.display=HIST_EDIT?'inline-block':'none';
  renderHistorial();
}
function saveHistEdits(){
  alert('Edici√≥n local aplicada. (Edici√≥n/guardado real del historial en DB no expuesto)');
  HIST_EDIT=false; renderHistorial();
}
function deleteHistRows(){
  alert('Eliminaci√≥n masiva de historial no expuesta por API (seguridad).');
}

/* ======= Admin ======= */
function loginAdmin(){
  ADMIN_OK=(ADMIN_PIN_DEFAULT===document.getElementById('pin-in').value) && isAdmin();
  document.getElementById('pin-ok').textContent=ADMIN_OK?'Acceso concedido':'PIN incorrecto (o no eres Admin)';
  document.getElementById('emp-add').disabled=!ADMIN_OK;
  document.getElementById('emp-save').disabled=!ADMIN_OK;
  document.getElementById('usr-add').disabled=!ADMIN_OK;
  document.getElementById('usr-save').disabled=!ADMIN_OK;
  if(!ADMIN_OK){ HIST_EDIT=false; renderHistorial(); }
}

async function renderEmpresasTable(){
  if(!isAdmin()){ document.getElementById('emp-table').innerHTML=''; return; }
  const list = await getJSON(`${API_BASE}/api/empresas`); // requiere token
  EMPRESAS_STATE = list.slice();

  let html=`<table class="tbl"><thead><tr>
    <th class="w-m">ID</th><th class="w-l">Raz√≥n Social</th><th class="w-m">RUC</th><th class="w-l">Direcci√≥n</th><th class="w-m">Tel√©fono</th><th class="w-l">Logo (dataURL o URL)</th>
  </tr></thead><tbody>`;
  EMPRESAS_STATE.forEach((e,idx)=>{
    html+=`<tr data-idx="${idx}">
      <td><input value="${e.id}" data-f="id" class="w-m"></td>
      <td><input value="${e.razon||''}" data-f="razon" class="uppercase w-l"></td>
      <td><input value="${e.ruc||''}" data-f="ruc" class="w-m"></td>
      <td><input value="${e.direccion||''}" data-f="direccion" class="uppercase w-l"></td>
      <td><input value="${e.telefono||''}" data-f="telefono" class="w-m"></td>
      <td><input value="${e.logo||''}" data-f="logo" class="w-l"></td>
    </tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('emp-table').innerHTML=html;
}
function empAdd(){
  if(!ADMIN_OK) return;
  EMPRESAS_STATE.push({id:'NEW_ID', razon:'', ruc:'', direccion:'', telefono:'', logo:''});
  renderEmpresasTable();
}
async function empSaveAll(){
  if(!ADMIN_OK) return;
  const rows=document.querySelectorAll('#emp-table tbody tr'); const list=[];
  rows.forEach(tr=>{
    const get=f=>tr.querySelector(`[data-f="${f}"]`).value.trim();
    list.push({id:get('id'), razon:get('razon').toUpperCase(), ruc:get('ruc'), direccion:get('direccion').toUpperCase(), telefono:get('telefono'), logo:get('logo')});
  });
  await fetch(`${API_BASE}/api/empresas`,{method:'PUT',headers:{'Content-Type':'application/json',...authHeader()},body:JSON.stringify(list)});
  alert('Empresas guardadas en DB.');
  renderEmpresasTable();
}

async function renderUsuariosTable(){
  if(!isAdmin()){ document.getElementById('usr-table').innerHTML=''; return; }
  const list = await getJSON(`${API_BASE}/api/usuarios`);
  USUARIOS_STATE = list.slice();

  const emps = EMPRESAS_STATE.length?EMPRESAS_STATE:(await getJSON(`${API_BASE}/api/empresas`));
  let html=`<table class="tbl"><thead><tr>
    <th class="w-s">Activo</th><th class="w-m">DNI</th><th class="w-l">Nombres</th><th class="w-l">Apellidos</th><th class="w-l">Empresa</th><th class="w-m">Rol</th><th class="w-l">Proy. Defecto</th><th class="w-l">Proyectos (coma)</th><th class="w-l">Email</th>
  </tr></thead><tbody>`;
  USUARIOS_STATE.forEach((u,idx)=>{
    html+=`<tr data-idx="${idx}">
      <td class="center"><input type="checkbox" data-f="activo" ${u.activo?'checked':''}></td>
      <td><input value="${u.dni}" data-f="dni" class="w-m"></td>
      <td><input value="${u.nombres||''}" data-f="nombres" class="uppercase w-l"></td>
      <td><input value="${u.apellidos||''}" data-f="apellidos" class="uppercase w-l"></td>
      <td><select data-f="empresaId" class="w-l">
        ${emps.map(e=>`<option value="${e.id}" ${e.id===u.empresa_id?'selected':''}>${e.razon}</option>`).join('')}
      </select></td>
      <td><select data-f="rol" class="w-m"><option value="ADMIN_PADOVA" ${u.rol==='ADMIN_PADOVA'?'selected':''}>ADMIN_PADOVA</option><option value="USUARIO" ${u.rol==='USUARIO'?'selected':''}>USUARIO</option></select></td>
      <td><input value="${u.proy_def||''}" data-f="proyDef" class="uppercase w-l"></td>
      <td><input value="${(u.proyectos||[]).join(', ')}" data-f="proyectos" class="uppercase w-l"></td>
      <td><input value="${u.email||''}" data-f="email" class="w-l"></td>
    </tr>`;
  });
  html+='</tbody></table>';
  document.getElementById('usr-table').innerHTML=html;
}
function usrAdd(){
  if(!ADMIN_OK) return;
  const firstEmp=(EMPRESAS_STATE[0]?.id)||'INV_PADOVA';
  USUARIOS_STATE.push({activo:true,dni:'NEW_DNI',nombres:'',apellidos:'',empresa_id:firstEmp,rol:'USUARIO',proyectos:[],proy_def:'',email:''});
  renderUsuariosTable();
}
async function usrSaveAll(){
  if(!ADMIN_OK) return;
  const rows=document.querySelectorAll('#usr-table tbody tr'); const list=[];
  rows.forEach(tr=>{
    const get=f=>tr.querySelector(`[data-f="${f}"]`);
    list.push({
      activo:get('activo').checked,
      dni:get('dni').value.trim(),
      nombres:get('nombres').value.trim(),
      apellidos:get('apellidos').value.trim(),
      empresaId:get('empresaId').value,
      rol:get('rol').value,
      proyDef:get('proyDef').value.trim(),
      proyectos:get('proyectos').value,
      email:get('email').value.trim()
    });
  });
  await fetch(`${API_BASE}/api/usuarios`,{method:'PUT',headers:{'Content-Type':'application/json',...authHeader()},body:JSON.stringify(list)});
  alert('Usuarios guardados en DB.');
  await renderUsuariosTable(); // recarga
  await renderTrabajadoresSelect(); // refresca selector
  onTrabajadorChange();
}

/* ======= Guardar + PDF ======= */
async function guardarPlanilla(){
  const u=currentUserFromState();
  if(!u){ alert('Seleccione un trabajador.'); return; }
  const fecha=document.getElementById('f-emision').value;
  const detalles=[];
  document.querySelectorAll('.trow').forEach(r=>{
    const destino=r.querySelector('.destino').value.trim().toUpperCase();
    const motivo=r.querySelector('.motivo').value.trim().toUpperCase();
    const proyecto=(r.querySelector('.proyecto')?.value||'').trim().toUpperCase() || (u.proy_def||'');
    const pc=r.querySelector('.pc').value.trim();
    const monto=parseFloat(r.querySelector('.monto').value)||0;
    if(monto>0){ detalles.push({destino,motivo,proyecto,pc,monto}); }
  });
  if(detalles.length===0){ alert('Ingrese al menos un √≠tem con monto.'); return; }

  // el tope ya lo valida el server; aqu√≠ solo UX
  try{
    const resp = await fetch(`${API_BASE}/api/planillas`,{
      method:'POST',
      headers:{'Content-Type':'application/json',...authHeader()},
      body:JSON.stringify({fecha,detalles})
    });
    const data = await resp.json();
    if(!resp.ok){ throw new Error(data?.error || 'Error al guardar'); }

    const { serie, num, total } = data;
    // PDF con n√∫mero/serie reales del servidor
    const doc=new jsPDF(); 
    const emp=EMPRESA_CACHE;
    if(emp?.logo){ 
      try{ doc.addImage(emp.logo, emp.logo.startsWith('data:image/png')?'PNG':'JPEG', 15, 12, 38, 10); }catch(_){}
    }
    doc.setFontSize(8); doc.setFont(undefined,'bold'); doc.text(emp?.razon||'',195,15,{align:'right'});
    doc.setFont(undefined,'normal'); if(emp?.ruc) doc.text(`R.U.C. ${emp.ruc}`,195,19,{align:'right'}); if(emp?.direccion) doc.text(emp.direccion,195,23,{align:'right'}); if(emp?.telefono) doc.text(`Telf.: ${emp.telefono}`,195,27,{align:'right'});
    doc.setFontSize(12); doc.setFont(undefined,'bold'); doc.text(`PLANILLA POR GASTO DE MOVILIDAD - Nro. ${serie}-${String(num).padStart(5,'0')}`, doc.internal.pageSize.getWidth()/2,45,{align:'center'});
    doc.setFontSize(10); doc.setFont(undefined,'normal'); doc.text(`Fecha de Emisi√≥n: ${fecha}`,15,60); doc.text(`Trabajador: ${u.nombres} ${u.apellidos}`,15,67); doc.text(`D.N.I.: ${u.dni}`,150,67);
    let y=80; doc.setFont(undefined,'bold'); doc.text('#',15,y); doc.text('Destino',28,y); doc.text('Motivo',78,y); doc.text('Proyecto',128,y); doc.text('PC',165,y); doc.text('Monto (S/)',195,y,{align:'right'});
    doc.line(15,y+2,195,y+2); y+=8; doc.setFont(undefined,'normal');
    detalles.forEach((d,i)=>{ doc.text(String(i+1),15,y); doc.text(doc.splitTextToSize(d.destino,45),28,y); doc.text(doc.splitTextToSize(d.motivo,45),78,y); doc.text(doc.splitTextToSize(d.proyecto,30),128,y); doc.text(d.pc,165,y); doc.text(Number(d.monto).toFixed(2),195,y,{align:'right'}); y+=10;});
    doc.line(15,y,195,y); y+=7; doc.setFont(undefined,'bold'); doc.text('Total S/.',165,y); doc.text(Number(total).toFixed(2),195,y,{align:'right'});
    doc.line(80,y+40,140,y+40); doc.text('Firma del Trabajador', doc.internal.pageSize.getWidth()/2,y+45,{align:'center'});
    doc.setFontSize(7); doc.setTextColor(100);
    const disclaimer="Base Legal: Inciso a1) del art√≠culo 37¬∞ del TUO de la Ley del Impuesto a la Renta e inciso v) del articulo 21¬∞ del Reglamento...";
    doc.text(doc.splitTextToSize(disclaimer,180),15, doc.internal.pageSize.getHeight()-20);
    doc.save(`Planilla_${serie}-${String(num).padStart(5,'0')}.pdf`);

    alert(`Planilla ${serie}-${String(num).padStart(5,'0')} guardada y exportada.`);
    renderRows(true); onTrabajadorChange(); show('hist');
    await refreshFromServer(true);
    renderHistorial();
  }catch(err){
    alert(err.message||String(err));
  }
}

/* ======= Sincronizaci√≥n con servidor (modo API) ======= */
async function refreshFromServer(silent=false){
  if(!SESSION?.dni) return;
  try{
    const rows = await getJSON(`${API_BASE}/api/planillas`);
    // Guardamos para render
    window.__HIST__ = (Array.isArray(rows)?rows:[]).map(r=>({
      serie:r.serie, num:r.num, fecha:r.fecha, trabajador:r.trabajador, email:r.email, dni:r.dni,
      total:Number(r.total||0), proyecto:r.proyecto, destino:r.destino, motivo:r.motivo, pc:r.pc, monto:Number(r.monto||0)
    }));
    if(!silent) renderHistorial();
  }catch(err){
    if(!silent) console.warn('No se pudo sincronizar historial:',err);
  }
}

/* ======== DEMO helpers (se mantienen visibles) ======== */
function openTrabajadorEditor(){ alert('Editor r√°pido local ocultado en modo API. Gestiona los usuarios en Ajustes (Admin).'); }
function closeModal(){} function saveModal(){}

/* ======== Modo local DEMO (no usado cuando MODE=api) ======== */
function localLogin(){ alert('Modo local deshabilitado (usa API).'); }
function resetDemo(){ alert('Modo DEMO: no aplica en API.'); }

</script>
</body>
</html>
